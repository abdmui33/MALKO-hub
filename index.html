<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Malko Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --g0: #0A0F0D;
  --g1: #111A16;
  --g2: #1A2820;
  --g3: #243530;
  --g4: #2F4840;
  --accent: #00C896;
  --accent2: #00A87D;
  --accent3: #007A5A;
  --accentglow: rgba(0,200,150,0.15);
  --accentpale: rgba(0,200,150,0.07);
  --text0: #F0FBF6;
  --text1: #B8D4C8;
  --text2: #7A9E90;
  --text3: #4A6E60;
  --border: rgba(0,200,150,0.12);
  --border2: rgba(255,255,255,0.06);
  --warn: #FF6B4A;
  --warnpale: rgba(255,107,74,0.12);
  --gold: #F0B429;
  --goldpale: rgba(240,180,41,0.1);
  --card: rgba(26,40,32,0.8);
  --radius: 10px;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Outfit', sans-serif;
}

*{margin:0;padding:0;box-sizing:border-box}
html{font-size:14px}

body{
  font-family:var(--sans);
  background:var(--g0);
  color:var(--text0);
  min-height:100vh;
  overflow-x:hidden;
}

/* Subtle grid background */
body::before{
  content:'';
  position:fixed;
  inset:0;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size:40px 40px;
  pointer-events:none;
  z-index:0;
  opacity:0.4;
}

.app{display:flex;min-height:100vh;position:relative;z-index:1}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:220px;
  background:linear-gradient(180deg, var(--g1) 0%, var(--g0) 100%);
  border-right:1px solid var(--border2);
  display:flex;
  flex-direction:column;
  position:fixed;
  height:100vh;
  left:0;top:0;
  z-index:100;
  overflow-y:auto;
}

.sb-brand{
  padding:24px 20px 18px;
  border-bottom:1px solid var(--border2);
}

.sb-logo{
  font-size:22px;
  font-weight:800;
  letter-spacing:-1px;
  color:var(--text0);
}
.sb-logo span{color:var(--accent)}
.sb-tag{
  font-family:var(--mono);
  font-size:9px;
  color:var(--text3);
  letter-spacing:1.5px;
  text-transform:uppercase;
  margin-top:3px;
}

.sb-sync{
  margin:10px 20px 0;
  display:flex;
  align-items:center;
  gap:6px;
  font-family:var(--mono);
  font-size:9px;
  color:var(--text3);
}
.sync-dot{
  width:6px;height:6px;
  border-radius:50%;
  background:var(--text3);
  transition:background 0.3s;
}
.sync-dot.synced{background:var(--accent);box-shadow:0 0 6px var(--accent)}
.sync-dot.syncing{background:var(--gold);animation:pulse 1s infinite}
.sync-dot.error{background:var(--warn)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

.sb-nav{padding:12px 0;flex:1}

.sb-section{
  font-family:var(--mono);
  font-size:9px;
  letter-spacing:1.5px;
  text-transform:uppercase;
  color:var(--text3);
  padding:10px 20px 4px;
}

.sb-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 20px;
  cursor:pointer;
  color:var(--text2);
  font-size:13px;
  font-weight:400;
  transition:all 0.15s;
  border-left:2px solid transparent;
  position:relative;
}
.sb-item:hover{color:var(--text0);background:var(--accentpale)}
.sb-item.active{
  color:var(--accent);
  background:var(--accentglow);
  border-left-color:var(--accent);
  font-weight:500;
}
.sb-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0}

.sb-bottom{
  padding:16px 20px;
  border-top:1px solid var(--border2);
}
.sb-user{font-weight:600;font-size:13px;color:var(--text0)}
.sb-role{font-size:11px;color:var(--text3);margin-top:2px}
.sb-reg{font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:6px;letter-spacing:0.5px}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{margin-left:220px;flex:1;display:flex;flex-direction:column;min-height:100vh}

.topbar{
  background:rgba(10,15,13,0.9);
  border-bottom:1px solid var(--border2);
  padding:16px 32px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:50;
  backdrop-filter:blur(12px);
}

.topbar-title{
  font-size:20px;font-weight:700;
  letter-spacing:-0.5px;
  color:var(--text0);
}
.topbar-sub{font-size:12px;color:var(--text2);margin-top:2px}

.topbar-actions{display:flex;gap:8px;align-items:center}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 16px;border-radius:8px;
  font-family:var(--sans);font-size:12px;font-weight:500;
  cursor:pointer;border:none;transition:all 0.15s;
  text-decoration:none;white-space:nowrap;
}
.btn-primary{background:var(--accent);color:var(--g0)}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,200,150,0.3)}
.btn-ghost{background:transparent;color:var(--text1);border:1px solid var(--border2)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:var(--accentpale)}
.btn-danger{background:var(--warnpale);color:var(--warn);border:1px solid rgba(255,107,74,0.2)}
.btn-danger:hover{background:var(--warn);color:white}
.btn-gold{background:var(--goldpale);color:var(--gold);border:1px solid rgba(240,180,41,0.2)}
.btn-sm{padding:5px 11px;font-size:11px}
.btn-xs{padding:3px 8px;font-size:10px}

/* ‚îÄ‚îÄ PAGE CONTENT ‚îÄ‚îÄ */
.content{padding:28px 32px;flex:1}
.page{animation:fadeUp 0.2s ease}
.page.hidden{display:none}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{
  background:var(--card);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  backdrop-filter:blur(8px);
}

.card-hd{
  padding:14px 18px;
  border-bottom:1px solid var(--border2);
  display:flex;align-items:center;justify-content:space-between;
  font-weight:600;font-size:13px;color:var(--text0);
}

/* ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
@media(max-width:900px){.stats{grid-template-columns:repeat(2,1fr)}}

.stat{
  background:var(--card);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  padding:18px 20px;
  position:relative;
  overflow:hidden;
  transition:border-color 0.2s;
}
.stat:hover{border-color:var(--border)}
.stat::after{
  content:'';position:absolute;
  top:0;right:0;width:60px;height:60px;
  border-radius:0 0 0 60px;
  opacity:0.08;
}
.stat-accent::after{background:var(--accent)}
.stat-gold::after{background:var(--gold)}
.stat-warn::after{background:var(--warn)}

.stat-label{
  font-family:var(--mono);font-size:9px;
  letter-spacing:1.5px;text-transform:uppercase;
  color:var(--text3);
}
.stat-val{
  font-size:26px;font-weight:700;
  margin:6px 0 2px;letter-spacing:-1px;
  color:var(--text0);
}
.stat-accent .stat-val{color:var(--accent)}
.stat-gold .stat-val{color:var(--gold)}
.stat-warn .stat-val{color:var(--warn)}
.stat-sub{font-size:11px;color:var(--text3)}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto}
table.tbl{width:100%;border-collapse:collapse}
.tbl th{
  font-family:var(--mono);font-size:9px;letter-spacing:1.2px;
  text-transform:uppercase;color:var(--text3);
  padding:10px 14px;text-align:left;
  border-bottom:1px solid var(--border2);
  background:rgba(0,0,0,0.2);
  white-space:nowrap;
}
.tbl td{
  padding:11px 14px;font-size:12px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  color:var(--text1);vertical-align:middle;
}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--accentpale)}

/* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
.badge{
  display:inline-flex;align-items:center;
  padding:2px 8px;border-radius:20px;
  font-family:var(--mono);font-size:10px;font-weight:500;
  letter-spacing:0.3px;
}
.badge-quo{background:rgba(99,102,241,0.15);color:#A5B4FC;border:1px solid rgba(99,102,241,0.2)}
.badge-inv{background:var(--goldpale);color:var(--gold);border:1px solid rgba(240,180,41,0.2)}
.badge-paid{background:rgba(0,200,150,0.1);color:var(--accent);border:1px solid rgba(0,200,150,0.2)}
.badge-pending{background:var(--warnpale);color:var(--warn);border:1px solid rgba(255,107,74,0.2)}
.badge-sent{background:rgba(99,102,241,0.1);color:#A5B4FC;border:1px solid rgba(99,102,241,0.15)}
.badge-draft{background:rgba(255,255,255,0.04);color:var(--text3);border:1px solid var(--border2)}
.badge-cancelled{background:rgba(255,255,255,0.04);color:var(--text3);border:1px solid var(--border2)}

/* ‚îÄ‚îÄ MONO TEXT ‚îÄ‚îÄ */
.mono{font-family:var(--mono)}
.accent{color:var(--accent)}
.gold{color:var(--gold)}
.warn{color:var(--warn)}
.muted{color:var(--text3)}
.soft{color:var(--text2)}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.fsec{
  background:var(--card);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  margin-bottom:16px;
  overflow:hidden;
}
.fsec-hd{
  padding:12px 18px;
  background:rgba(0,0,0,0.3);
  border-bottom:1px solid var(--border2);
  font-size:12px;font-weight:600;
  color:var(--accent);letter-spacing:0.3px;
  display:flex;align-items:center;gap:8px;
}
.fsec-body{padding:18px}

.fgrid{display:grid;gap:14px}
.f2{grid-template-columns:1fr 1fr}
.f3{grid-template-columns:1fr 1fr 1fr}
.f4{grid-template-columns:1fr 1fr 1fr 1fr}
.span2{grid-column:span 2}
.span3{grid-column:span 3}
.span4{grid-column:span 4}

.fgrp{display:flex;flex-direction:column;gap:5px}

label{
  font-family:var(--mono);font-size:9px;
  letter-spacing:1.2px;text-transform:uppercase;
  color:var(--text3);font-weight:400;
}

input,textarea,select{
  font-family:var(--sans);font-size:13px;
  padding:8px 11px;
  background:rgba(0,0,0,0.3);
  border:1px solid var(--border2);
  border-radius:7px;
  color:var(--text0);
  transition:border-color 0.15s,box-shadow 0.15s;
  width:100%;outline:none;
}
input:focus,textarea:focus,select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accentglow);
}
input::placeholder,textarea::placeholder{color:var(--text3)}
select option{background:var(--g2);color:var(--text0)}
textarea{resize:vertical;min-height:65px}
input[type=number]::-webkit-inner-spin-button{opacity:0.2}

/* ‚îÄ‚îÄ LINE ITEMS ‚îÄ‚îÄ */
.li-hd,.li-row{
  display:grid;
  grid-template-columns:32px 1fr 110px 70px 120px 34px;
  gap:6px;padding:7px 14px;
  align-items:center;
}
.li-hd{
  background:rgba(0,0,0,0.3);
  border-bottom:1px solid var(--border2);
  font-family:var(--mono);font-size:9px;
  letter-spacing:1px;text-transform:uppercase;
  color:var(--text3);
}
.li-row{border-bottom:1px solid rgba(255,255,255,0.03)}
.li-row:last-child{border-bottom:none}
.li-row input{padding:6px 9px;font-size:12px}
.li-num{
  font-family:var(--mono);font-size:11px;
  color:var(--text3);text-align:center;
}
.rm-btn{
  width:28px;height:28px;border-radius:6px;
  border:1px solid var(--border2);
  background:transparent;color:var(--text3);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:15px;transition:all 0.15s;
}
.rm-btn:hover{border-color:var(--warn);color:var(--warn);background:var(--warnpale)}

.totals-wrap{
  padding:14px 18px;
  background:rgba(0,0,0,0.2);
  border-top:1px solid var(--border2);
  display:flex;justify-content:flex-end;
}
.totals-box{min-width:260px}
.tot-row{
  display:flex;justify-content:space-between;
  align-items:center;padding:4px 0;
  font-size:12px;color:var(--text2);
}
.tot-grand{
  border-top:1px solid var(--accent);
  margin-top:8px;padding-top:10px;
  color:var(--text0);font-weight:600;font-size:15px;
}
.tot-grand .tot-amt{
  font-family:var(--mono);
  font-size:19px;color:var(--accent);
}
.tot-amt{font-family:var(--mono);font-size:12px}

/* ‚îÄ‚îÄ COST ROWS ‚îÄ‚îÄ */
.cost-hd,.cost-row{
  display:grid;
  grid-template-columns:1fr 120px 120px 120px 34px;
  gap:6px;padding:7px 14px;align-items:center;
}
.cost-hd{
  background:rgba(0,0,0,0.3);
  border-bottom:1px solid var(--border2);
  font-family:var(--mono);font-size:9px;
  letter-spacing:1px;text-transform:uppercase;color:var(--text3);
}
.cost-row{border-bottom:1px solid rgba(255,255,255,0.03)}
.cost-row input,
.cost-row select{padding:6px 9px;font-size:12px}

/* ‚îÄ‚îÄ ACTIONS BAR ‚îÄ‚îÄ */
.actbar{
  display:flex;gap:8px;padding:16px 32px;
  background:rgba(10,15,13,0.95);
  border-top:1px solid var(--border2);
  position:sticky;bottom:0;z-index:40;
  backdrop-filter:blur(12px);
}

/* ‚îÄ‚îÄ DOC NUMBER PILL ‚îÄ‚îÄ */
.docpill{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--accentglow);
  border:1px solid rgba(0,200,150,0.25);
  border-radius:6px;padding:5px 12px;
  font-family:var(--mono);font-size:13px;
  color:var(--accent);font-weight:500;
}

/* ‚îÄ‚îÄ PDF PREVIEW OVERLAY ‚îÄ‚îÄ */
.overlay{
  position:fixed;inset:0;
  background:rgba(5,10,8,0.85);
  z-index:200;
  display:flex;align-items:flex-start;justify-content:center;
  padding:24px;overflow-y:auto;
  backdrop-filter:blur(8px);
}
.overlay.hidden{display:none}
.overlay-inner{width:100%;max-width:840px}
.overlay-bar{
  display:flex;gap:8px;justify-content:flex-end;
  margin-bottom:12px;
}

/* ‚îÄ‚îÄ PRINT DOC ‚îÄ‚îÄ */
.pdoc{
  background:#fff;
  padding:44px 48px;
  color:#111;
  font-family:'Outfit',sans-serif;
  border-radius:4px;
  min-height:900px;
}
.pdoc-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px}
.pdoc-logo{font-size:28px;font-weight:800;color:#0A0F0D;letter-spacing:-1px}
.pdoc-logo span{color:#00C896}
.pdoc-tagline{font-size:10px;color:#888;margin-top:2px;font-family:'Outfit',sans-serif}
.pdoc-info{font-size:10.5px;color:#555;margin-top:8px;line-height:1.7}
.pdoc-type{text-align:right}
.pdoc-typename{
  font-size:34px;font-weight:800;
  color:#00A87D;letter-spacing:-1px;
  text-transform:uppercase;
}
.pdoc-meta{font-family:'JetBrains Mono',monospace;font-size:10px;color:#666;margin-top:6px;line-height:1.9;text-align:right}
.pdoc-meta strong{color:#111}
.pdoc-divider{height:2px;background:linear-gradient(90deg,#00C896,#E8F7F2);border:none;margin:22px 0}
.pdoc-billto{margin-bottom:26px}
.pdoc-billlabel{
  font-family:'JetBrains Mono',monospace;
  font-size:8.5px;letter-spacing:1.5px;
  text-transform:uppercase;color:#00A87D;margin-bottom:5px;
}
.pdoc-billname{font-size:15px;font-weight:700;color:#111}
.pdoc-billsub{font-size:11px;color:#666;margin-top:3px;line-height:1.6}

.pdoc-table{width:100%;border-collapse:collapse;margin-bottom:0}
.pdoc-table thead tr{background:#0A0F0D}
.pdoc-table th{
  padding:9px 13px;
  font-family:'JetBrains Mono',monospace;
  font-size:9px;letter-spacing:1px;
  text-transform:uppercase;color:#fff;font-weight:400;
}
.pdoc-table th.r,.pdoc-table td.r{text-align:right}
.pdoc-table td{
  padding:10px 13px;font-size:12px;
  border-bottom:1px solid #EEF2F0;
  vertical-align:top;
}
.pdoc-table tr:nth-child(even) td{background:#F7FCF9}
.pdoc-totals{display:flex;justify-content:flex-end}
.pdoc-totbox{min-width:250px;background:#F7FCF9;padding:14px 16px}
.pdoc-totrow{display:flex;justify-content:space-between;padding:3px 0;font-size:11.5px;color:#666}
.pdoc-totgrand{
  border-top:2px solid #00C896;margin-top:7px;padding-top:9px;
  color:#111;font-weight:700;font-size:14px;
}
.pdoc-totgrand .pdoc-amt{color:#00A87D;font-size:17px;font-family:'JetBrains Mono',monospace}
.pdoc-amt{font-family:'JetBrains Mono',monospace;font-size:11.5px}
.pdoc-footer{
  margin-top:32px;padding-top:18px;
  border-top:1px solid #EEF2F0;
  display:flex;justify-content:space-between;align-items:flex-end;
}
.pdoc-terms{font-size:10.5px;color:#888;max-width:320px;line-height:1.65}
.pdoc-terms strong{color:#555}
.pdoc-bank{text-align:right}
.pdoc-banklabel{font-family:'JetBrains Mono',monospace;font-size:8.5px;letter-spacing:1px;text-transform:uppercase;color:#00A87D;margin-bottom:4px}
.pdoc-bankinfo{font-size:10.5px;color:#666;line-height:1.7;font-family:'JetBrains Mono',monospace}
.pdoc-sig{margin-top:36px;text-align:right}
.pdoc-sigline{width:180px;height:1px;background:#ccc;margin-left:auto;margin-bottom:6px}
.pdoc-signame{font-size:11px;color:#888}

/* ‚îÄ‚îÄ CLIENT CARDS ‚îÄ‚îÄ */
.clicard{
  background:var(--card);border:1px solid var(--border2);
  border-radius:var(--radius);padding:16px;
  cursor:pointer;transition:all 0.15s;
}
.clicard:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 20px var(--accentglow)}
.cliname{font-size:13px;font-weight:600;color:var(--text0);margin-bottom:3px}
.clisub{font-family:var(--mono);font-size:10px;color:var(--text3);margin-bottom:8px}
.cliinfo{font-size:11.5px;color:var(--text2);line-height:1.7}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-bg{
  position:fixed;inset:0;
  background:rgba(5,10,8,0.8);
  z-index:300;display:flex;
  align-items:center;justify-content:center;
  backdrop-filter:blur(8px);
}
.modal-bg.hidden{display:none}
.modal{
  background:var(--g2);
  border:1px solid var(--border2);
  border-radius:14px;
  padding:26px;width:460px;
  max-width:95vw;
  box-shadow:0 20px 60px rgba(0,0,0,0.6);
}
.modal-title{
  font-size:16px;font-weight:700;
  color:var(--text0);margin-bottom:18px;
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:24px;right:24px;
  background:var(--g2);
  border:1px solid var(--border2);
  color:var(--text0);
  padding:11px 18px;border-radius:10px;
  font-size:12px;z-index:999;
  display:flex;align-items:center;gap:8px;
  transform:translateY(80px);opacity:0;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 8px 30px rgba(0,0,0,0.4);
  max-width:320px;
}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-left:3px solid var(--accent)}
.toast.err{border-left:3px solid var(--warn)}
.toast.info{border-left:3px solid var(--gold)}

/* ‚îÄ‚îÄ SETUP BANNER ‚îÄ‚îÄ */
.setup-banner{
  background:linear-gradient(135deg,var(--g2),var(--g3));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px 24px;
  margin-bottom:24px;
  display:flex;align-items:flex-start;gap:16px;
}
.setup-icon{font-size:28px;flex-shrink:0;margin-top:2px}
.setup-title{font-size:15px;font-weight:700;color:var(--accent);margin-bottom:4px}
.setup-text{font-size:12px;color:var(--text2);line-height:1.7}

/* ‚îÄ‚îÄ PROFIT BAR ‚îÄ‚îÄ */
.profit-bar{height:5px;border-radius:3px;background:var(--g3);overflow:hidden;margin-top:6px}
.profit-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent3),var(--accent));transition:width 0.5s}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{text-align:center;padding:50px 20px;color:var(--text3)}
.empty-ico{font-size:42px;margin-bottom:12px}
.empty-title{font-size:15px;font-weight:600;color:var(--text2);margin-bottom:6px}
.empty-sub{font-size:12px}

/* ‚îÄ‚îÄ QUICK JOB VIEW ‚îÄ‚îÄ */
.job-detail{
  background:var(--g2);border:1px solid var(--border2);
  border-radius:var(--radius);padding:18px;margin-bottom:12px;
}
.job-detail-title{
  font-size:12px;font-weight:600;color:var(--accent);
  font-family:var(--mono);letter-spacing:0.5px;
  margin-bottom:10px;
  display:flex;align-items:center;justify-content:space-between;
}

/* scrollbar */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--g4);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--accent3)}
</style>
</head>
<body>
<div class="app">

<!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
<nav class="sidebar">
  <div class="sb-brand">
    <div class="sb-logo">malko<span>‚Ä∫</span></div>
    <div class="sb-tag">Business Hub v2</div>
    <div class="sb-sync">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">Not connected</span>
    </div>
  </div>
  <div class="sb-nav">
    <div class="sb-section">Overview</div>
    <div class="sb-item active" onclick="nav('dashboard',this)"><span class="sb-icon">‚¨°</span>Dashboard</div>
    <div class="sb-section" style="margin-top:8px">Create</div>
    <div class="sb-item" onclick="nav('new-quo',this)"><span class="sb-icon">‚óà</span>New Quotation</div>
    <div class="sb-item" onclick="nav('new-inv',this)"><span class="sb-icon">‚óâ</span>New Invoice</div>
    <div class="sb-section" style="margin-top:8px">Records</div>
    <div class="sb-item" onclick="nav('tracker',this)"><span class="sb-icon">‚ó´</span>Job Tracker</div>
    <div class="sb-item" onclick="nav('clients',this)"><span class="sb-icon">‚óé</span>Clients</div>
    <div class="sb-section" style="margin-top:8px">Finance</div>
    <div class="sb-item" onclick="nav('pl',this)"><span class="sb-icon">‚ó∞</span>P&amp;L Report</div>
    <div class="sb-section" style="margin-top:8px">Settings</div>
    <div class="sb-item" onclick="nav('settings',this)"><span class="sb-icon">‚öô</span>Sync Setup</div>
  </div>
  <div class="sb-bottom">
    <div class="sb-user">Muizz Zainuddin</div>
    <div class="sb-role">Alliance Director ¬∑ Founder</div>
    <div class="sb-reg">JR0170620-X</div>
  </div>
</nav>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<div class="main">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-dashboard" class="page">
  <div class="topbar">
    <div>
      <div class="topbar-title">Good day, Muizz üëã</div>
      <div class="topbar-sub" id="dash-date"></div>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-ghost" onclick="nav('new-quo',document.querySelector('[onclick*=new-quo]'))">+ Quotation</button>
      <button class="btn btn-primary" onclick="nav('new-inv',document.querySelector('[onclick*=new-inv]'))">+ Invoice</button>
    </div>
  </div>
  <div class="content">
    <div id="setup-banner-wrap"></div>
    <div class="stats" id="dash-stats">
      <div class="stat stat-accent"><div class="stat-label">Total Invoiced</div><div class="stat-val" id="s-inv">RM 0</div><div class="stat-sub" id="s-inv-c">0 invoices</div></div>
      <div class="stat stat-gold"><div class="stat-label">Net to Malko</div><div class="stat-val" id="s-net">RM 0</div><div class="stat-sub">after vendor costs</div></div>
      <div class="stat stat-warn"><div class="stat-label">Outstanding</div><div class="stat-val" id="s-out">RM 0</div><div class="stat-sub" id="s-out-c">unpaid invoices</div></div>
      <div class="stat"><div class="stat-label">Vendor Payables</div><div class="stat-val" id="s-vend">RM 0</div><div class="stat-sub">owed to suppliers</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-hd">Recent Invoices <button class="btn btn-ghost btn-xs" onclick="nav('tracker',document.querySelector('[onclick*=tracker]'))">All ‚Üí</button></div>
        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>No.</th><th>Client</th><th>Amount</th><th>Status</th></tr></thead><tbody id="d-inv-body"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-hd">Recent Quotations <button class="btn btn-ghost btn-xs" onclick="nav('tracker',document.querySelector('[onclick*=tracker]'))">All ‚Üí</button></div>
        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>No.</th><th>Client</th><th>Amount</th><th>Date</th></tr></thead><tbody id="d-quo-body"></tbody></table></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW QUOTATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-new-quo" class="page hidden">
  <div class="topbar">
    <div><div class="topbar-title">New Quotation</div><div class="topbar-sub">Create a professional quotation</div></div>
    <div class="docpill" id="quo-pill">QUO-117</div>
  </div>
  <div class="content" style="padding-bottom:80px">
    <div class="fsec">
      <div class="fsec-hd">üìã Document Info</div>
      <div class="fsec-body">
        <div class="fgrid f3">
          <div class="fgrp"><label>Quotation No.</label><input id="q-num" oninput="document.getElementById('quo-pill').textContent=this.value"></div>
          <div class="fgrp"><label>Date</label><input type="date" id="q-date"></div>
          <div class="fgrp"><label>Valid (Days)</label><input type="number" id="q-valid" value="14"></div>
        </div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-hd">üè¢ Client</div>
      <div class="fsec-body">
        <div class="fgrid f2" style="margin-bottom:12px">
          <div class="fgrp"><label>Quick Select</label><select id="q-cli-sel" onchange="fillCli('q',this.value)"><option value="">‚Äî existing client ‚Äî</option></select></div>
        </div>
        <div class="fgrid f2">
          <div class="fgrp"><label>Company / Name *</label><input id="q-cname" placeholder="Client company name"></div>
          <div class="fgrp"><label>Attention</label><input id="q-cattn" placeholder="Person name"></div>
          <div class="fgrp span2"><label>Address</label><textarea id="q-caddr" rows="2" placeholder="Full address"></textarea></div>
          <div class="fgrp"><label>Email</label><input id="q-cemail" type="email" placeholder="email@company.com"></div>
          <div class="fgrp"><label>Phone</label><input id="q-cphone" placeholder="01x-xxxx xxxx"></div>
        </div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-hd">üì¶ Line Items</div>
      <div class="li-hd"><span>#</span><span>Description</span><span style="text-align:right">Unit Price</span><span style="text-align:right">Qty</span><span style="text-align:right">Amount (RM)</span><span></span></div>
      <div id="q-items"></div>
      <div style="padding:10px 14px;border-top:1px solid var(--border2)">
        <button class="btn btn-ghost btn-sm" onclick="addLI('q')">+ Add Item</button>
      </div>
      <div class="totals-wrap">
        <div class="totals-box">
          <div class="tot-row"><span>Subtotal</span><span class="tot-amt" id="q-sub">RM 0.00</span></div>
          <div class="tot-row"><span>Discount (RM)</span><input type="number" id="q-disc" value="0" min="0" style="width:80px;padding:4px 8px;font-size:11px;text-align:right" onchange="calcTot('q')"></div>
          <div class="tot-row"><span>Tax (%)</span><input type="number" id="q-tax" value="0" min="0" max="100" style="width:60px;padding:4px 8px;font-size:11px;text-align:right" onchange="calcTot('q')"></div>
          <div class="tot-row"><span>Tax Amt</span><span class="tot-amt" id="q-taxamt">RM 0.00</span></div>
          <div class="tot-row tot-grand"><span>TOTAL</span><span class="tot-amt" id="q-tot">RM 0.00</span></div>
        </div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-hd">üìù Notes & Terms</div>
      <div class="fsec-body">
        <div class="fgrid f2">
          <div class="fgrp"><label>Notes / Scope</label><textarea id="q-notes" placeholder="Scope, delivery details..."></textarea></div>
          <div class="fgrp"><label>Terms & Conditions</label><textarea id="q-terms">Payment Terms: 50% Upon Order, 50% Upon Delivery.
Acceptance confirmed by issuance of a Purchase Order.
This is a computer-generated document.</textarea></div>
        </div>
      </div>
    </div>
  </div>
  <div class="actbar">
    <button class="btn btn-primary" onclick="savePreview('q')">üëÅ Preview & Print PDF</button>
    <button class="btn btn-ghost" onclick="saveDoc('q')">üíæ Save</button>
    <button class="btn btn-ghost" onclick="resetForm('q')">üóë Clear</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW INVOICE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-new-inv" class="page hidden">
  <div class="topbar">
    <div><div class="topbar-title">New Invoice</div><div class="topbar-sub">Generate a payment invoice</div></div>
    <div class="docpill" id="inv-pill">INV-116</div>
  </div>
  <div class="content" style="padding-bottom:80px">
    <div class="fsec">
      <div class="fsec-hd">üìã Document Info</div>
      <div class="fsec-body">
        <div class="fgrid f4">
          <div class="fgrp"><label>Invoice No.</label><input id="i-num" oninput="document.getElementById('inv-pill').textContent=this.value"></div>
          <div class="fgrp"><label>Invoice Date</label><input type="date" id="i-date"></div>
          <div class="fgrp"><label>Due Date</label><input type="date" id="i-due"></div>
          <div class="fgrp"><label>Ref Quotation</label><input id="i-refq" placeholder="QUO-xxx"></div>
        </div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-hd">üè¢ Client</div>
      <div class="fsec-body">
        <div class="fgrid f2" style="margin-bottom:12px">
          <div class="fgrp"><label>Quick Select</label><select id="i-cli-sel" onchange="fillCli('i',this.value)"><option value="">‚Äî existing client ‚Äî</option></select></div>
        </div>
        <div class="fgrid f2">
          <div class="fgrp"><label>Company / Name *</label><input id="i-cname" placeholder="Client company name"></div>
          <div class="fgrp"><label>Attention</label><input id="i-cattn" placeholder="Person name"></div>
          <div class="fgrp span2"><label>Address</label><textarea id="i-caddr" rows="2" placeholder="Full address"></textarea></div>
          <div class="fgrp"><label>Email</label><input id="i-cemail" type="email" placeholder="email@company.com"></div>
          <div class="fgrp"><label>Phone</label><input id="i-cphone" placeholder="01x-xxxx xxxx"></div>
        </div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-hd">üì¶ Line Items</div>
      <div class="li-hd"><span>#</span><span>Description</span><span style="text-align:right">Unit Price</span><span style="text-align:right">Qty</span><span style="text-align:right">Amount (RM)</span><span></span></div>
      <div id="i-items"></div>
      <div style="padding:10px 14px;border-top:1px solid var(--border2)">
        <button class="btn btn-ghost btn-sm" onclick="addLI('i')">+ Add Item</button>
      </div>
      <div class="totals-wrap">
        <div class="totals-box">
          <div class="tot-row"><span>Subtotal</span><span class="tot-amt" id="i-sub">RM 0.00</span></div>
          <div class="tot-row"><span>Discount (RM)</span><input type="number" id="i-disc" value="0" min="0" style="width:80px;padding:4px 8px;font-size:11px;text-align:right" onchange="calcTot('i')"></div>
          <div class="tot-row"><span>Tax (%)</span><input type="number" id="i-tax" value="0" min="0" max="100" style="width:60px;padding:4px 8px;font-size:11px;text-align:right" onchange="calcTot('i')"></div>
          <div class="tot-row"><span>Tax Amt</span><span class="tot-amt" id="i-taxamt">RM 0.00</span></div>
          <div class="tot-row tot-grand"><span>TOTAL</span><span class="tot-amt" id="i-tot">RM 0.00</span></div>
        </div>
      </div>
    </div>
    <!-- JOB COSTS SECTION -->
    <div class="fsec">
      <div class="fsec-hd">üí∞ Job Costs (Vendors / Subcons / Suppliers)</div>
      <div class="cost-hd"><span>Vendor / Supplier Name</span><span>Amount (RM)</span><span>Category</span><span>Pay Status</span><span></span></div>
      <div id="i-costs"></div>
      <div style="padding:10px 14px;border-top:1px solid var(--border2)">
        <button class="btn btn-ghost btn-sm" onclick="addCost('i')">+ Add Cost</button>
      </div>
      <div style="padding:12px 18px;background:rgba(0,0,0,0.2);border-top:1px solid var(--border2)">
        <div class="fgrid f3" style="gap:12px">
          <div style="text-align:center;padding:10px;background:var(--accentpale);border-radius:8px;border:1px solid var(--border)">
            <div class="muted mono" style="font-size:9px;letter-spacing:1px;margin-bottom:4px">GROSS PROFIT</div>
            <div class="accent mono" style="font-size:16px;font-weight:600" id="i-gross">RM 0.00</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--goldpale);border-radius:8px;border:1px solid rgba(240,180,41,0.15)">
            <div class="muted mono" style="font-size:9px;letter-spacing:1px;margin-bottom:4px">MALKO SHARE (%)</div>
            <input type="number" id="i-share" value="100" min="0" max="100" style="width:70px;text-align:center;padding:3px;font-size:15px;font-weight:600;background:transparent;border:none;color:var(--gold)" onchange="calcCosts('i')">
          </div>
          <div style="text-align:center;padding:10px;background:rgba(0,200,150,0.05);border-radius:8px;border:1px solid var(--border)">
            <div class="muted mono" style="font-size:9px;letter-spacing:1px;margin-bottom:4px">YOUR NET</div>
            <div class="accent mono" style="font-size:16px;font-weight:600" id="i-netval">RM 0.00</div>
          </div>
        </div>
      </div>
    </div>
    <div class="fsec">
      <div class="fsec-hd">üìù Notes & Payment</div>
      <div class="fsec-body">
        <div class="fgrid f2">
          <div class="fgrp"><label>Notes</label><textarea id="i-notes" placeholder="Description of goods/services..."></textarea></div>
          <div class="fgrp"><label>Payment Terms</label><textarea id="i-terms">Payment due within 30 days of invoice date.
Bank: CIMB Bank Berhad
Account: MALKO SOLUTIONS
Acc No: 8606011612
This is a computer-generated document.</textarea></div>
        </div>
      </div>
    </div>
  </div>
  <div class="actbar">
    <button class="btn btn-primary" onclick="savePreview('i')">üëÅ Preview & Print PDF</button>
    <button class="btn btn-ghost" onclick="saveDoc('i')">üíæ Save</button>
    <button class="btn btn-ghost" onclick="resetForm('i')">üóë Clear</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRACKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-tracker" class="page hidden">
  <div class="topbar">
    <div><div class="topbar-title">Job Tracker</div><div class="topbar-sub">All documents with status &amp; cost tracking</div></div>
    <div class="topbar-actions">
      <input type="text" id="search" placeholder="Search client / doc no..." style="width:220px;padding:7px 12px;font-size:12px" oninput="renderTracker()">
    </div>
  </div>
  <div class="content">
    <div style="display:flex;gap:8px;margin-bottom:16px" id="trk-filters">
      <div class="btn btn-ghost btn-sm active-filter" onclick="setFilter('all',this)">All</div>
      <div class="btn btn-ghost btn-sm" onclick="setFilter('QUO',this)">Quotations</div>
      <div class="btn btn-ghost btn-sm" onclick="setFilter('INV',this)">Invoices</div>
      <div class="btn btn-ghost btn-sm" onclick="setFilter('paid',this)">Paid</div>
      <div class="btn btn-ghost btn-sm" onclick="setFilter('pending',this)">Pending</div>
    </div>
    <div class="card">
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr>
            <th>Doc No.</th><th>Type</th><th>Client</th>
            <th>Revenue</th><th>Cost</th><th>Net</th>
            <th>Date</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="trk-body"></tbody>
        </table>
      </div>
      <div id="trk-empty" class="empty hidden"><div class="empty-ico">‚ó´</div><div class="empty-title">No documents</div><div class="empty-sub">Create a quotation or invoice to begin</div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLIENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-clients" class="page hidden">
  <div class="topbar">
    <div><div class="topbar-title">Client Address Book</div><div class="topbar-sub">Quick-fill clients for faster document creation</div></div>
    <button class="btn btn-primary" onclick="openCliModal()">+ Add Client</button>
  </div>
  <div class="content">
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px" id="cli-grid"></div>
    <div id="cli-empty" class="empty hidden"><div class="empty-ico">‚óé</div><div class="empty-title">No clients yet</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê P&L ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-pl" class="page hidden">
  <div class="topbar">
    <div><div class="topbar-title">P&amp;L Report</div><div class="topbar-sub">Profit &amp; Loss ‚Äî ready for LHDN / IRB Form B</div></div>
    <button class="btn btn-gold" onclick="exportPL()">‚¨á Export for IRB</button>
  </div>
  <div class="content">
    <div class="stats" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat stat-accent"><div class="stat-label">Gross Revenue</div><div class="stat-val" id="pl-rev">RM 0</div><div class="stat-sub">total invoiced</div></div>
      <div class="stat"><div class="stat-label">Total Costs</div><div class="stat-val" id="pl-cost">RM 0</div><div class="stat-sub">vendors &amp; subcons</div></div>
      <div class="stat stat-gold"><div class="stat-label">Net Income</div><div class="stat-val" id="pl-net">RM 0</div><div class="stat-sub">your actual take-home</div></div>
      <div class="stat stat-warn"><div class="stat-label">Vendor Payables</div><div class="stat-val" id="pl-pay">RM 0</div><div class="stat-sub">still owed to vendors</div></div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-hd">Per-Job Breakdown</div>
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr><th>Doc No.</th><th>Client</th><th>Revenue</th><th>Costs</th><th>Gross%</th><th>Your Net</th><th>Vendor Paid?</th></tr></thead>
          <tbody id="pl-job-body"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">Monthly Summary (for IRB)</div>
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr><th>Month</th><th>Invoices</th><th>Revenue</th><th>Costs</th><th>Net Income</th></tr></thead>
          <tbody id="pl-month-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-settings" class="page hidden">
  <div class="topbar">
    <div><div class="topbar-title">Sync Setup</div><div class="topbar-sub">Connect to Google Sheets for cross-device access</div></div>
  </div>
  <div class="content">
    <div class="fsec" style="max-width:680px">
      <div class="fsec-hd">üîó Google Apps Script URL</div>
      <div class="fsec-body">
        <div style="background:var(--accentpale);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:18px;font-size:12px;color:var(--text1);line-height:1.8">
          <strong style="color:var(--accent)">One-time setup (5 minutes):</strong><br><br>
          <strong>1.</strong> Open your Google Sheet ‚Üí click <strong>Extensions ‚Üí Apps Script</strong><br>
          <strong>2.</strong> Delete everything, paste the script below, click <strong>Save</strong><br>
          <strong>3.</strong> Click <strong>Deploy ‚Üí New deployment ‚Üí Web app</strong><br>
          <strong>4.</strong> Set "Execute as: <strong>Me</strong>" and "Who has access: <strong>Anyone</strong>"<br>
          <strong>5.</strong> Click <strong>Deploy</strong> ‚Üí copy the Web App URL ‚Üí paste below<br>
          <strong>6.</strong> On first use, Google will ask you to authorize ‚Äî click Allow
        </div>
        <div class="fgrp" style="margin-bottom:14px">
          <label>Your Apps Script Web App URL</label>
          <input id="gs-url" placeholder="https://script.google.com/macros/s/AKfyc.../exec" value="">
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" onclick="saveGsUrl()">Save & Test Connection</button>
          <button class="btn btn-ghost" onclick="syncNow()">‚Üª Sync Now</button>
          <button class="btn btn-ghost" onclick="exportLocalJSON()">‚¨á Backup Local Data</button>
        </div>
        <div id="conn-status" style="margin-top:12px;font-size:12px;color:var(--text2)"></div>
      </div>
    </div>
    <div class="fsec" style="max-width:680px">
      <div class="fsec-hd">üìã Apps Script Code ‚Äî copy &amp; paste this</div>
      <div class="fsec-body">
        <pre id="gas-code" style="background:var(--g0);border:1px solid var(--border2);border-radius:8px;padding:16px;font-family:var(--mono);font-size:10.5px;color:var(--text1);overflow-x:auto;white-space:pre;line-height:1.6;max-height:420px;overflow-y:auto"></pre>
        <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="copyGAS()">Copy Script</button>
      </div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /app -->

<!-- PDF OVERLAY -->
<div class="overlay hidden" id="pdf-overlay">
  <div class="overlay-inner">
    <div class="overlay-bar">
      <button class="btn btn-primary" onclick="printPDF()">üñ® Print / Save as PDF</button>
      <button class="btn btn-ghost" onclick="closePDF()">‚úï Close</button>
    </div>
    <div id="pdf-content"></div>
  </div>
</div>

<!-- CLIENT MODAL -->
<div class="modal-bg hidden" id="cli-modal">
  <div class="modal">
    <div class="modal-title">üë§ Client Details</div>
    <div class="fgrid" style="gap:11px">
      <input type="hidden" id="cm-id">
      <div class="fgrp"><label>Company / Name *</label><input id="cm-name" placeholder="Full name or company"></div>
      <div class="fgrp"><label>Contact Person</label><input id="cm-attn" placeholder="Att: name"></div>
      <div class="fgrp"><label>Email</label><input id="cm-email" type="email" placeholder="email@company.com"></div>
      <div class="fgrp"><label>Phone</label><input id="cm-phone" placeholder="01x-xxxx xxxx"></div>
      <div class="fgrp"><label>Address</label><textarea id="cm-addr" rows="3" placeholder="Full address"></textarea></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:18px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeCliModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCli()">Save Client</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS = {
  get:(k)=>JSON.parse(localStorage.getItem('mk2_'+k)||'null'),
  set:(k,v)=>localStorage.setItem('mk2_'+k,JSON.stringify(v)),
  arr:(k)=>JSON.parse(localStorage.getItem('mk2_'+k)||'[]'),
};

let trkFilter = 'all';
let currentPreviewDoc = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEED DATA ‚Äî all 15 existing jobs pre-loaded
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function seedData(){
  if(LS.get('seeded')) return;

  const clients = [
    {id:1,name:'Techmile Resources Sdn Bhd',attn:'',email:'',phone:'',addr:'1378045-K'},
    {id:2,name:'Shakur Resources Sdn Bhd',attn:'Hafiz Razman',email:'shakur.bizgroup@gmail.com',phone:'010-2147414',addr:'38, Jalan Perdana 5/4, Pandan Perdana, 55300 Kuala Lumpur'},
    {id:3,name:'Simplycare Bio Co., Ltd',attn:'Jaero Yun',email:'jryun@simplycare.co.kr',phone:'+82 10 5920 9792',addr:'2F, 46, Nonhyeon-ro 105-gil, Gangnam-gu, Seoul, Korea 06125'},
    {id:4,name:'Destra Sinistra Enterprise',attn:'',email:'',phone:'',addr:''},
    {id:5,name:'GAD Present Resources',attn:'',email:'',phone:'',addr:'59, Tingkat 2, Jalan Tuanku Antah, 70100 Seremban, NS'},
    {id:6,name:'Ahmad Aizuddin bin Mohammad Aris',attn:'Ahmad Aizuddin',email:'',phone:'',addr:'68000 Ampang, Selangor'},
  ];
  LS.set('clients', clients);

  const docs = [
    // INV-102
    {type:'INV',docNumber:'INV-102',date:'2025-01-15',dueDate:'2025-02-14',refQuo:'',
     clientName:'Techmile Resources Sdn Bhd',clientAttn:'',clientAddr:'',clientEmail:'',clientPhone:'',
     items:[{desc:'SWAK‚Ñ¢ Anaerobic Thread Sealant, 50cm¬≥ Tube',price:2250,qty:1,amount:2250}],
     discount:0,taxRate:0,taxAmt:0,subtotal:2250,total:2250,
     costs:[{vendor:'Swagelok Malaysia Fluid Systems Technologies Sdn Bhd',amount:1365.50,cat:'Supplier',paid:true}],
     malkoShare:65,notes:'',terms:'',status:'paid',createdAt:'2025-01-15'},
    // INV-105
    {type:'INV',docNumber:'INV-105',date:'2025-03-10',dueDate:'2025-04-09',refQuo:'',
     clientName:'Destra Sinistra Enterprise',clientAttn:'',clientAddr:'',clientEmail:'',clientPhone:'',
     items:[{desc:'Procurement & Supply Services',price:3500,qty:1,amount:3500}],
     discount:0,taxRate:0,taxAmt:0,subtotal:3500,total:3500,
     costs:[{vendor:'Destra Sinistra Enterprise (cost)',amount:2400,cat:'Subcontractor',paid:true}],
     malkoShare:100,notes:'',terms:'',status:'paid',createdAt:'2025-03-10'},
    // INV-106
    {type:'INV',docNumber:'INV-106',date:'2025-12-16',dueDate:'2026-01-15',refQuo:'',
     clientName:'Simplycare Bio Co., Ltd',clientAttn:'Jaero Yun',clientAddr:'Seoul, Korea',clientEmail:'jryun@simplycare.co.kr',clientPhone:'+82 10 5920 9792',
     items:[{desc:'Interpreter Service: Attachment for Mr. Cho Gil Hyeong, Mayor of Chungju City (16 Dec 2025)',price:800,qty:1,amount:800}],
     discount:0,taxRate:0,taxAmt:0,subtotal:800,total:800,
     costs:[],malkoShare:100,notes:'Full-day interpretation service',terms:'',status:'paid',createdAt:'2025-12-16'},
    // INV-107
    {type:'INV',docNumber:'INV-107',date:'2025-06-01',dueDate:'2025-07-01',refQuo:'QUO-107',
     clientName:'Techmile Resources Sdn Bhd',clientAttn:'',clientAddr:'',clientEmail:'',clientPhone:'',
     items:[{desc:'To Supply Cast Nylon Sheet',price:1250,qty:1,amount:1250}],
     discount:0,taxRate:0,taxAmt:0,subtotal:1250,total:1250,
     costs:[{vendor:'NBH Engineering & Industrial Sdn Bhd',amount:617.30,cat:'Supplier',paid:true}],
     malkoShare:60,notes:'',terms:'',status:'paid',createdAt:'2025-06-01'},
    // INV-109
    {type:'INV',docNumber:'INV-109',date:'2026-01-09',dueDate:'2026-02-08',refQuo:'QUO-108',
     clientName:'Shakur Resources Sdn Bhd',clientAttn:'Hafiz Razman',clientAddr:'38, Jalan Perdana 5/4, Pandan Perdana, 55300 KL',clientEmail:'shakur.bizgroup@gmail.com',clientPhone:'010-2147414',
     items:[{desc:'To Supply Multiple IT Products (Laptops, Peripherals, Accessories)',price:6716,qty:1,amount:6716}],
     discount:0,taxRate:0,taxAmt:0,subtotal:6716,total:6716,
     costs:[{vendor:'Shopee (procurement)',amount:4149.65,cat:'Supplier',paid:true},{vendor:'Partner commission',amount:600,cat:'Partner',paid:true}],
     malkoShare:100,notes:'',terms:'',status:'paid',createdAt:'2026-01-09'},
    // INV-110
    {type:'INV',docNumber:'INV-110',date:'2026-01-09',dueDate:'2026-02-08',refQuo:'',
     clientName:'Shakur Resources Sdn Bhd',clientAttn:'Hafiz Razman',clientAddr:'38, Jalan Perdana 5/4, Pandan Perdana, 55300 KL',clientEmail:'shakur.bizgroup@gmail.com',clientPhone:'010-2147414',
     items:[{desc:'Supply & Deliver MSI RTX 5070 Graphic Card',price:2150,qty:1,amount:2150},{desc:'Supply & Deliver MSI GeForce RTX 5050 Shadow 8GB',price:1690,qty:1,amount:1690}],
     discount:0,taxRate:0,taxAmt:0,subtotal:3840,total:3380,
     costs:[{vendor:'Shakur Resources Sdn Bhd (cost)',amount:2600,cat:'Supplier',paid:true}],
     malkoShare:100,notes:'',terms:'',status:'paid',createdAt:'2026-01-09'},
    // INV-111
    {type:'INV',docNumber:'INV-111',date:'2026-01-09',dueDate:'2026-02-08',refQuo:'',
     clientName:'Shakur Resources Sdn Bhd',clientAttn:'Hafiz Razman',clientAddr:'38, Jalan Perdana 5/4, Pandan Perdana, 55300 KL',clientEmail:'shakur.bizgroup@gmail.com',clientPhone:'010-2147414',
     items:[{desc:'Supply & Deliver AGI SSD SATA 1TB ‚Äì 4 Units',price:2150,qty:1,amount:2150}],
     discount:0,taxRate:0,taxAmt:0,subtotal:2150,total:2150,
     costs:[{vendor:'Shakur Resources (cost)',amount:1625,cat:'Supplier',paid:true}],
     malkoShare:100,notes:'',terms:'',status:'paid',createdAt:'2026-01-09'},
    // INV-112 (AGI SSD)
    {type:'INV',docNumber:'INV-112',date:'2026-01-15',dueDate:'2026-02-14',refQuo:'',
     clientName:'Shakur Resources Sdn Bhd',clientAttn:'Hafiz Razman',clientAddr:'',clientEmail:'shakur.bizgroup@gmail.com',clientPhone:'010-2147414',
     items:[{desc:'Supply AGI SSD SATA 1T ‚Äì 4 Unit',price:675,qty:1,amount:675}],
     discount:0,taxRate:0,taxAmt:0,subtotal:675,total:675,
     costs:[{vendor:'Shakur Resources (cost)',amount:500,cat:'Supplier',paid:true}],
     malkoShare:100,notes:'',terms:'',status:'paid',createdAt:'2026-01-15'},
    // INV-113
    {type:'INV',docNumber:'INV-113',date:'2026-02-03',dueDate:'2026-03-05',refQuo:'QUO-113',
     clientName:'Simplycare Bio Co., Ltd',clientAttn:'Jaero Yun',clientAddr:'2F, 46, Nonhyeon-ro 105-gil, Gangnam-gu, Seoul',clientEmail:'jryun@simplycare.co.kr',clientPhone:'+82 10 5920 9792',
     items:[{desc:'Professional Agri/Tech Interpretation & Meeting Report (2 Sessions √ó 2 Days)',price:1500,qty:2,amount:3000}],
     discount:0,taxRate:0,taxAmt:0,subtotal:3000,total:3000,
     costs:[],malkoShare:100,notes:'Sessions: 6 Feb & 11 Feb 2026',terms:'',status:'paid',createdAt:'2026-02-03'},
    // INV-114
    {type:'INV',docNumber:'INV-114',date:'2026-02-09',dueDate:'2026-03-11',refQuo:'',
     clientName:'Shakur Resources Sdn Bhd',clientAttn:'Hafiz Razman',clientAddr:'38, Jalan Perdana 5/4, Pandan Perdana, 55300 KL',clientEmail:'shakur.bizgroup@gmail.com',clientPhone:'010-2147414',
     items:[{desc:'Dismantle, Supply & Install 1HP Inverter Daikin Aircond (Free 6ft copper, drain pipe, outdoor bracket)\nInstallation: Plaza 33, Petaling Jaya',price:2300,qty:1,amount:2300}],
     discount:0,taxRate:0,taxAmt:0,subtotal:2300,total:2300,
     costs:[{vendor:'MNB Construction',amount:1800,cat:'Subcontractor',paid:false}],
     malkoShare:100,notes:'',terms:'',status:'paid',createdAt:'2026-02-09'},
    // INV-115
    {type:'INV',docNumber:'INV-115',date:'2026-02-12',dueDate:'2026-03-14',refQuo:'',
     clientName:'Ahmad Aizuddin bin Mohammad Aris',clientAttn:'Ahmad Aizuddin',clientAddr:'38, Jalan Perdana 5/4, Pandan Perdana, 68000 Ampang, Selangor',clientEmail:'',clientPhone:'',
     items:[{desc:'ThinkPad Lenovo T490 i5 vPro 16GB RAM 256GB SSD',price:600,qty:1,amount:600}],
     discount:0,taxRate:0,taxAmt:0,subtotal:600,total:600,
     costs:[],malkoShare:100,notes:'',terms:'',status:'pending',createdAt:'2026-02-12'},
    // QUO-103
    {type:'QUO',docNumber:'QUO-103',date:'2025-04-01',validity:14,
     clientName:'Techmile Resources Sdn Bhd',clientAttn:'',clientAddr:'',clientEmail:'',clientPhone:'',
     items:[{desc:'Supply of U-Bolts (various sizes)',price:18449,qty:1,amount:18449}],
     discount:0,taxRate:0,taxAmt:0,subtotal:18449,total:18449,
     costs:[],malkoShare:100,notes:'',terms:'',status:'sent',createdAt:'2025-04-01'},
    // QUO-104
    {type:'QUO',docNumber:'QUO-104',date:'2025-05-01',validity:14,
     clientName:'Techmile Resources Sdn Bhd',clientAttn:'',clientAddr:'',clientEmail:'',clientPhone:'',
     items:[{desc:'Customized Ex-Proof Distribution Board (DB Board)',price:66960,qty:1,amount:66960}],
     discount:0,taxRate:0,taxAmt:0,subtotal:66960,total:66960,
     costs:[],malkoShare:100,notes:'',terms:'',status:'sent',createdAt:'2025-05-01'},
    // QUO-112 (Francis Barker Compass)
    {type:'QUO',docNumber:'QUO-112',date:'2026-01-26',validity:14,
     clientName:'GAD Present Resources',clientAttn:'',clientAddr:'59, Tingkat 2, Jalan Tuanku Antah, 70100 Seremban, NS',clientEmail:'',clientPhone:'',
     items:[{desc:'Francis Barker Prismatic Compass M-73 Mils (NATO Standard, Tritium illumination)',price:3460,qty:10,amount:34600},{desc:'Export/Import Clearance, Custom Clearance, SST',price:200,qty:1,amount:200},{desc:'Door-to-Door Courier Service',price:565.50,qty:1,amount:565.50}],
     discount:0,taxRate:0,taxAmt:0,subtotal:35365.50,total:34600,
     costs:[],malkoShare:100,notes:'Payment: 50% upon order, 50% after pre-shipment inspection in UK',terms:'',status:'sent',createdAt:'2026-01-26'},
    // QUO-116
    {type:'QUO',docNumber:'QUO-116',date:'2026-02-20',validity:14,
     clientName:'Shakur Resources Sdn Bhd',clientAttn:'Hafiz Razman',clientAddr:'',clientEmail:'shakur.bizgroup@gmail.com',clientPhone:'010-2147414',
     items:[{desc:'Supply & Deliver Stationeries (as per requirement list)',price:0,qty:1,amount:0}],
     discount:0,taxRate:0,taxAmt:0,subtotal:0,total:0,
     costs:[],malkoShare:100,notes:'Awaiting item list & pricing',terms:'',status:'draft',createdAt:'2026-02-20'},
  ];
  LS.set('documents', docs);
  LS.set('seeded', true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nav(pg, el){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.querySelectorAll('.sb-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('pg-'+pg).classList.remove('hidden');
  if(el) el.classList.add('active');
  if(pg==='dashboard') renderDash();
  if(pg==='tracker') renderTracker();
  if(pg==='clients') renderCli();
  if(pg==='pl') renderPL();
  if(pg==='new-quo'){
    document.getElementById('q-num').value = nextNum('q');
    document.getElementById('quo-pill').textContent = document.getElementById('q-num').value;
  }
  if(pg==='new-inv'){
    document.getElementById('i-num').value = nextNum('i');
    document.getElementById('inv-pill').textContent = document.getElementById('i-num').value;
  }
  if(pg==='settings') renderSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOC NUMBER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nextNum(t){
  const docs = LS.arr('documents');
  const pfx = t==='q'?'QUO-':'INV-';
  const base = t==='q'?117:116;
  const nums = docs.filter(d=>d.docNumber&&d.docNumber.startsWith(pfx))
    .map(d=>parseInt(d.docNumber.replace(pfx,''))||0);
  const max = nums.length?Math.max(...nums):base-1;
  return pfx+(max+1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LINE ITEMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLI(t, desc='', price='', qty='1'){
  const wrap = document.getElementById(t+'-items');
  const n = wrap.children.length+1;
  const d = document.createElement('div');
  d.className='li-row';
  d.innerHTML=`
    <span class="li-num">${n}</span>
    <input type="text" placeholder="Description" value="${desc}" oninput="calcTot('${t}')">
    <input type="number" placeholder="0.00" value="${price}" min="0" step="0.01" style="text-align:right" oninput="calcTot('${t}')">
    <input type="number" placeholder="1" value="${qty}" min="0.01" step="any" style="text-align:right" oninput="calcTot('${t}')">
    <input type="text" readonly style="text-align:right;background:var(--accentpale);color:var(--accent);font-family:var(--mono);font-size:11px" placeholder="0.00">
    <button class="rm-btn" onclick="rmLI(this,'${t}')">√ó</button>`;
  wrap.appendChild(d);
  calcTot(t);
}

function rmLI(btn,t){
  const wrap=document.getElementById(t+'-items');
  if(wrap.children.length>1){btn.closest('.li-row').remove();renumLI(t);calcTot(t);}
}
function renumLI(t){
  [...document.getElementById(t+'-items').children].forEach((r,i)=>r.querySelector('.li-num').textContent=i+1);
}

function calcTot(t){
  const wrap=document.getElementById(t+'-items');
  let sub=0;
  [...wrap.children].forEach(r=>{
    const ins=r.querySelectorAll('input[type=number]');
    const p=parseFloat(ins[0].value)||0,q=parseFloat(ins[1].value)||0;
    const a=p*q; r.querySelectorAll('input')[3].value=a.toFixed(2); sub+=a;
  });
  const disc=parseFloat(document.getElementById(t+'-disc').value)||0;
  const taxR=parseFloat(document.getElementById(t+'-tax').value)||0;
  const taxA=(sub-disc)*(taxR/100);
  const tot=sub-disc+taxA;
  document.getElementById(t+'-sub').textContent='RM '+sub.toFixed(2);
  document.getElementById(t+'-taxamt').textContent='RM '+taxA.toFixed(2);
  document.getElementById(t+'-tot').textContent='RM '+tot.toFixed(2);
  if(t==='i') calcCosts('i');
  return{sub,disc,taxA,tot};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COSTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCost(t, vendor='', amount='', cat='Supplier', paid=false){
  const wrap=document.getElementById(t+'-costs');
  const d=document.createElement('div');
  d.className='cost-row';
  d.innerHTML=`
    <input type="text" placeholder="Vendor / Supplier name" value="${vendor}" oninput="calcCosts('${t}')">
    <input type="number" placeholder="0.00" value="${amount}" min="0" step="0.01" style="text-align:right;font-family:var(--mono)" oninput="calcCosts('${t}')">
    <select onchange="calcCosts('${t}')">
      <option ${cat==='Supplier'?'selected':''}>Supplier</option>
      <option ${cat==='Subcontractor'?'selected':''}>Subcontractor</option>
      <option ${cat==='Partner'?'selected':''}>Partner</option>
      <option ${cat==='Transport'?'selected':''}>Transport</option>
      <option ${cat==='Other'?'selected':''}>Other</option>
    </select>
    <select onchange="calcCosts('${t}')">
      <option value="false" ${!paid?'selected':''}>Unpaid ‚è≥</option>
      <option value="true" ${paid?'selected':''}>Paid ‚úì</option>
    </select>
    <button class="rm-btn" onclick="this.closest('.cost-row').remove();calcCosts('${t}')">√ó</button>`;
  wrap.appendChild(d);
  calcCosts(t);
}

function calcCosts(t){
  const wrap=document.getElementById(t+'-costs');
  let totalCost=0;
  [...wrap.children].forEach(r=>{
    const amt=parseFloat(r.querySelectorAll('input[type=number]')[0].value)||0;
    totalCost+=amt;
  });
  const totEl=document.getElementById(t+'-tot');
  const revenue=parseFloat((totEl.textContent||'').replace('RM ','').replace(/,/g,''))||0;
  const gross=revenue-totalCost;
  const share=parseFloat(document.getElementById(t+'-share').value)||100;
  const net=gross*(share/100);
  if(document.getElementById(t+'-gross')) document.getElementById(t+'-gross').textContent='RM '+gross.toFixed(2);
  if(document.getElementById(t+'-netval')) document.getElementById(t+'-netval').textContent='RM '+net.toFixed(2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT FILL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fillCli(t, id){
  if(!id)return;
  const c=LS.arr('clients').find(x=>x.id==id);
  if(!c)return;
  document.getElementById(t+'-cname').value=c.name||'';
  document.getElementById(t+'-cattn').value=c.attn||'';
  document.getElementById(t+'-caddr').value=c.addr||'';
  document.getElementById(t+'-cemail').value=c.email||'';
  document.getElementById(t+'-cphone').value=c.phone||'';
}

function refreshSelects(){
  const clients=LS.arr('clients');
  ['q-cli-sel','i-cli-sel'].forEach(id=>{
    const sel=document.getElementById(id);
    sel.innerHTML='<option value="">‚Äî existing client ‚Äî</option>';
    clients.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLLECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collect(t){
  const wrap=document.getElementById(t+'-items');
  const items=[...wrap.children].map(r=>{
    const ins=r.querySelectorAll('input');
    return{desc:ins[1].value,price:parseFloat(ins[2].value)||0,qty:parseFloat(ins[3].value)||1,amount:parseFloat(ins[4].value)||0};
  }).filter(i=>i.desc.trim());
  const disc=parseFloat(document.getElementById(t+'-disc').value)||0;
  const taxR=parseFloat(document.getElementById(t+'-tax').value)||0;
  const sub=items.reduce((s,i)=>s+i.amount,0);
  const taxA=(sub-disc)*(taxR/100);
  const tot=sub-disc+taxA;

  const base={
    clientName:document.getElementById(t+'-cname').value,
    clientAttn:document.getElementById(t+'-cattn').value,
    clientAddr:document.getElementById(t+'-caddr').value,
    clientEmail:document.getElementById(t+'-cemail').value,
    clientPhone:document.getElementById(t+'-cphone').value,
    items,discount:disc,taxRate:taxR,taxAmt:taxA,subtotal:sub,total:tot,
    createdAt:new Date().toISOString()
  };

  if(t==='q') return{...base,type:'QUO',docNumber:document.getElementById('q-num').value,date:document.getElementById('q-date').value,validity:document.getElementById('q-valid').value,notes:document.getElementById('q-notes').value,terms:document.getElementById('q-terms').value,costs:[],malkoShare:100,status:'sent'};

  // Invoice ‚Äî also collect costs
  const costWrap=document.getElementById('i-costs');
  const costs=[...costWrap.children].map(r=>{
    const inps=r.querySelectorAll('input');
    const sels=r.querySelectorAll('select');
    return{vendor:inps[0].value,amount:parseFloat(inps[1].value)||0,cat:sels[0].value,paid:sels[1].value==='true'};
  }).filter(c=>c.vendor.trim());
  const share=parseFloat(document.getElementById('i-share').value)||100;

  return{...base,type:'INV',docNumber:document.getElementById('i-num').value,date:document.getElementById('i-date').value,dueDate:document.getElementById('i-due').value,refQuo:document.getElementById('i-refq').value,notes:document.getElementById('i-notes').value,terms:document.getElementById('i-terms').value,costs,malkoShare:share,status:'pending'};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveDoc(t){
  const data=collect(t);
  if(!data.clientName){toast('Enter client name','err');return false;}
  if(!data.items.length){toast('Add at least one line item','err');return false;}
  const docs=LS.arr('documents');
  const idx=docs.findIndex(d=>d.docNumber===data.docNumber);
  if(idx>=0) docs[idx]=data; else docs.push(data);
  LS.set('documents',docs);
  autoSaveCli(data);
  toast(data.docNumber+' saved ‚úì','ok');
  renderDash();
  syncToSheets(data);
  return data;
}

function autoSaveCli(data){
  if(!data.clientName)return;
  const clients=LS.arr('clients');
  if(!clients.find(c=>c.name.toLowerCase()===data.clientName.toLowerCase())){
    clients.push({id:Date.now(),name:data.clientName,attn:data.clientAttn,email:data.clientEmail,phone:data.clientPhone,addr:data.clientAddr});
    LS.set('clients',clients);
    refreshSelects();
  }
}

function savePreview(t){
  const data=saveDoc(t);
  if(!data)return;
  currentPreviewDoc=data;
  showPDF(data);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetForm(t){
  if(!confirm('Clear form?'))return;
  const today=new Date().toISOString().split('T')[0];
  if(t==='q'){
    ['q-cname','q-cattn','q-caddr','q-cemail','q-cphone','q-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('q-date').value=today;
    document.getElementById('q-disc').value='0';document.getElementById('q-tax').value='0';
    document.getElementById('q-items').innerHTML='';addLI('q');
    const n=nextNum('q');document.getElementById('q-num').value=n;document.getElementById('quo-pill').textContent=n;
  }else{
    ['i-cname','i-cattn','i-caddr','i-cemail','i-cphone','i-notes','i-refq'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('i-date').value=today;
    const due=new Date();due.setDate(due.getDate()+30);
    document.getElementById('i-due').value=due.toISOString().split('T')[0];
    document.getElementById('i-disc').value='0';document.getElementById('i-tax').value='0';
    document.getElementById('i-items').innerHTML='';addLI('i');
    document.getElementById('i-costs').innerHTML='';
    document.getElementById('i-share').value='100';
    calcCosts('i');
    const n=nextNum('i');document.getElementById('i-num').value=n;document.getElementById('inv-pill').textContent=n;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtD(d){if(!d)return'';try{return new Date(d+'T00:00:00').toLocaleDateString('en-MY',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return d;}}
function fmtM(n){return'RM '+(parseFloat(n)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}

function showPDF(doc){
  const isInv=doc.type==='INV';
  const rows=doc.items.map((item,i)=>`
    <tr>
      <td style="color:#999;font-family:'JetBrains Mono',monospace;font-size:10px">${i+1}</td>
      <td>${(item.desc||'').replace(/\n/g,'<br>')}</td>
      <td class="r">${fmtM(item.price)}</td>
      <td class="r">${item.qty}</td>
      <td class="r" style="font-weight:500">${fmtM(item.amount)}</td>
    </tr>`).join('');

  document.getElementById('pdf-content').innerHTML=`
    <div class="pdoc" id="the-pdoc">
      <div class="pdoc-head">
        <div>
          <div class="pdoc-logo">malko<span>‚Ä∫</span></div>
          <div class="pdoc-tagline">Solutions Engineered, Value Delivered</div>
          <div class="pdoc-info">MALKO SOLUTIONS &nbsp;|&nbsp; JR0170620-X<br>59, Tingkat 2, Jalan Tuanku Antah, 70100 Seremban, NS<br>+6017-2330580 &nbsp;|&nbsp; malkosolutions@gmail.com</div>
        </div>
        <div class="pdoc-type">
          <div class="pdoc-typename">${isInv?'Invoice':'Quotation'}</div>
          <div class="pdoc-meta">
            <strong>${isInv?'Invoice':'Quotation'} No:</strong> ${doc.docNumber}<br>
            <strong>Date:</strong> ${fmtD(doc.date)}<br>
            ${isInv?`<strong>Due:</strong> ${fmtD(doc.dueDate)}`:` <strong>Valid:</strong> ${doc.validity||14} days`}<br>
            ${isInv&&doc.refQuo?`<strong>Ref:</strong> ${doc.refQuo}`:''}
          </div>
        </div>
      </div>
      <hr class="pdoc-divider">
      <div class="pdoc-billto">
        <div class="pdoc-billlabel">${isInv?'Billed To':'Quoted To'}</div>
        <div class="pdoc-billname">${doc.clientName}</div>
        <div class="pdoc-billsub">${doc.clientAttn?'Att: '+doc.clientAttn+'<br>':''}${(doc.clientAddr||'').replace(/\n/g,'<br>')}${doc.clientEmail?'<br>'+doc.clientEmail:''}${doc.clientPhone?' &nbsp;|&nbsp; '+doc.clientPhone:''}</div>
      </div>
      <table class="pdoc-table">
        <thead><tr>
          <th style="width:30px">#</th><th>Description</th>
          <th class="r" style="width:110px">Unit Price</th>
          <th class="r" style="width:50px">Qty</th>
          <th class="r" style="width:110px">Amount</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="pdoc-totals">
        <div class="pdoc-totbox">
          <div class="pdoc-totrow"><span>Subtotal</span><span class="pdoc-amt">${fmtM(doc.subtotal)}</span></div>
          ${doc.discount?`<div class="pdoc-totrow"><span>Discount</span><span class="pdoc-amt">‚àí ${fmtM(doc.discount)}</span></div>`:''}
          ${doc.taxRate?`<div class="pdoc-totrow"><span>Tax (${doc.taxRate}%)</span><span class="pdoc-amt">${fmtM(doc.taxAmt)}</span></div>`:''}
          <div class="pdoc-totrow pdoc-totgrand"><span>TOTAL</span><span class="pdoc-amt">${fmtM(doc.total)}</span></div>
        </div>
      </div>
      <div class="pdoc-footer">
        <div class="pdoc-terms"><strong>Notes &amp; Terms</strong><br>${(doc.notes?doc.notes+'<br><br>':'')}${(doc.terms||'').replace(/\n/g,'<br>')}</div>
        <div class="pdoc-bank">
          <div class="pdoc-banklabel">Payment To</div>
          <div class="pdoc-bankinfo">MALKO SOLUTIONS<br>CIMB Bank Berhad<br>8606011612</div>
        </div>
      </div>
      <div class="pdoc-sig">
        <div class="pdoc-sigline"></div>
        <div class="pdoc-signame">Muizz Zainuddin<br><span style="color:#999;font-size:9.5px">Alliance Director | Founder, Malko Solutions</span></div>
      </div>
    </div>`;
  document.getElementById('pdf-overlay').classList.remove('hidden');
}

function closePDF(){document.getElementById('pdf-overlay').classList.add('hidden');}
function printPDF(){window.print();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDash(){
  document.getElementById('dash-date').textContent=new Date().toLocaleDateString('en-MY',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  const docs=LS.arr('documents');
  const invs=docs.filter(d=>d.type==='INV');
  const quos=docs.filter(d=>d.type==='QUO');

  const totalInv=invs.reduce((s,d)=>s+parseFloat(d.total||0),0);
  const totalCosts=invs.reduce((s,d)=>s+((d.costs||[]).reduce((cs,c)=>cs+parseFloat(c.amount||0),0)),0);
  const netMalko=invs.reduce((s,d)=>{
    const cost=(d.costs||[]).reduce((cs,c)=>cs+parseFloat(c.amount||0),0);
    const gross=parseFloat(d.total||0)-cost;
    return s+gross*((d.malkoShare||100)/100);
  },0);
  const outstanding=invs.filter(d=>d.status!=='paid'&&d.status!=='cancelled').reduce((s,d)=>s+parseFloat(d.total||0),0);
  const vendorOwed=invs.reduce((s,d)=>s+((d.costs||[]).filter(c=>!c.paid).reduce((cs,c)=>cs+parseFloat(c.amount||0),0)),0);

  document.getElementById('s-inv').textContent='RM '+totalInv.toLocaleString('en-MY',{minimumFractionDigits:0,maximumFractionDigits:0});
  document.getElementById('s-inv-c').textContent=invs.length+' invoice'+(invs.length!==1?'s':'');
  document.getElementById('s-net').textContent='RM '+netMalko.toLocaleString('en-MY',{minimumFractionDigits:0,maximumFractionDigits:0});
  document.getElementById('s-out').textContent='RM '+outstanding.toLocaleString('en-MY',{minimumFractionDigits:0,maximumFractionDigits:0});
  document.getElementById('s-out-c').textContent=invs.filter(d=>d.status==='pending').length+' pending';
  document.getElementById('s-vend').textContent='RM '+vendorOwed.toLocaleString('en-MY',{minimumFractionDigits:0,maximumFractionDigits:0});

  // Setup banner
  const gsUrl=LS.get('gs_url');
  const bannerWrap=document.getElementById('setup-banner-wrap');
  if(!gsUrl){
    bannerWrap.innerHTML=`<div class="setup-banner">
      <div class="setup-icon">‚òÅ</div>
      <div>
        <div class="setup-title">Sync not configured ‚Äî data is local only</div>
        <div class="setup-text">To access your data on phone, laptop, and any device, connect Google Sheets sync.<br>Takes 5 minutes. Completely free. <a href="#" onclick="nav('settings',document.querySelector('[onclick*=settings]'));return false" style="color:var(--accent)">Set up now ‚Üí</a></div>
      </div>
    </div>`;
  } else {
    bannerWrap.innerHTML='';
  }

  // Recent tables
  const ibody=document.getElementById('d-inv-body');
  const recent5inv=[...invs].reverse().slice(0,5);
  ibody.innerHTML=recent5inv.length?recent5inv.map(d=>`
    <tr>
      <td class="mono accent" style="font-size:11px">${d.docNumber}</td>
      <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.clientName}</td>
      <td class="mono" style="font-size:11px">${fmtM(d.total)}</td>
      <td><span class="badge badge-${d.status}">${d.status}</span></td>
    </tr>`).join(''):`<tr><td colspan="4" class="empty-sub" style="text-align:center;padding:20px">No invoices yet</td></tr>`;

  const qbody=document.getElementById('d-quo-body');
  const recent5quo=[...quos].reverse().slice(0,5);
  qbody.innerHTML=recent5quo.length?recent5quo.map(d=>`
    <tr>
      <td class="mono" style="font-size:11px;color:#A5B4FC">${d.docNumber}</td>
      <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.clientName}</td>
      <td class="mono" style="font-size:11px">${fmtM(d.total)}</td>
      <td style="font-size:11px" class="muted">${d.date||''}</td>
    </tr>`).join(''):`<tr><td colspan="4" class="empty-sub" style="text-align:center;padding:20px">No quotations yet</td></tr>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(f,el){
  trkFilter=f;
  document.querySelectorAll('#trk-filters .btn').forEach(b=>{b.style.color='';b.style.borderColor='';b.style.background='';});
  el.style.color='var(--accent)';el.style.borderColor='var(--accent)';el.style.background='var(--accentpale)';
  renderTracker();
}

function renderTracker(){
  const q=(document.getElementById('search')||{value:''}).value.toLowerCase();
  let docs=LS.arr('documents');
  if(trkFilter==='QUO') docs=docs.filter(d=>d.type==='QUO');
  else if(trkFilter==='INV') docs=docs.filter(d=>d.type==='INV');
  else if(trkFilter==='paid') docs=docs.filter(d=>d.status==='paid');
  else if(trkFilter==='pending') docs=docs.filter(d=>d.status==='pending');
  if(q) docs=docs.filter(d=>d.docNumber.toLowerCase().includes(q)||d.clientName.toLowerCase().includes(q));

  const tbody=document.getElementById('trk-body');
  const empty=document.getElementById('trk-empty');
  if(!docs.length){tbody.innerHTML='';empty.classList.remove('hidden');return;}
  empty.classList.add('hidden');

  tbody.innerHTML=[...docs].reverse().map(d=>{
    const cost=(d.costs||[]).reduce((s,c)=>s+parseFloat(c.amount||0),0);
    const gross=parseFloat(d.total||0)-cost;
    const net=gross*((d.malkoShare||100)/100);
    const hasCosts=d.type==='INV'&&cost>0;
    const grossPct=d.total>0?Math.round(gross/d.total*100):100;
    return`<tr>
      <td class="mono" style="font-size:11px;color:${d.type==='INV'?'var(--gold)':'#A5B4FC'};font-weight:600">${d.docNumber}</td>
      <td><span class="badge badge-${d.type.toLowerCase()}">${d.type}</span></td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px">${d.clientName}</td>
      <td class="mono" style="font-size:11px">${fmtM(d.total)}</td>
      <td class="mono warn" style="font-size:11px">${hasCosts?fmtM(cost):'‚Äî'}</td>
      <td class="mono accent" style="font-size:11px">${d.type==='INV'?fmtM(net):'‚Äî'}</td>
      <td class="muted" style="font-size:11px">${d.date||''}</td>
      <td>
        <select onchange="updStatus('${d.docNumber}',this.value)" style="font-size:11px;padding:4px 7px;border-radius:5px;background:var(--g2);border:1px solid var(--border2);color:var(--text1)">
          <option ${d.status==='draft'?'selected':''} value="draft">Draft</option>
          <option ${d.status==='sent'?'selected':''} value="sent">Sent</option>
          <option ${d.status==='pending'?'selected':''} value="pending">Pending</option>
          <option ${d.status==='paid'?'selected':''} value="paid">Paid ‚úì</option>
          <option ${d.status==='cancelled'?'selected':''} value="cancelled">Cancelled</option>
        </select>
      </td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="btn btn-ghost btn-xs" onclick="viewDoc('${d.docNumber}')">View</button>
          <button class="btn btn-danger btn-xs" onclick="delDoc('${d.docNumber}')">Del</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function updStatus(num,status){
  const docs=LS.arr('documents');
  const d=docs.find(x=>x.docNumber===num);
  if(d){d.status=status;LS.set('documents',docs);syncToSheets(d);}
  renderDash();
  toast(num+' ‚Üí '+status,'ok');
}

function viewDoc(num){
  const d=LS.arr('documents').find(x=>x.docNumber===num);
  if(d){currentPreviewDoc=d;showPDF(d);}
}

function delDoc(num){
  if(!confirm('Delete '+num+'? Cannot undo.'))return;
  LS.set('documents',LS.arr('documents').filter(d=>d.docNumber!==num));
  renderTracker();renderDash();
  toast(num+' deleted','err');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCli(){
  const clients=LS.arr('clients');
  const grid=document.getElementById('cli-grid');
  const empty=document.getElementById('cli-empty');
  if(!clients.length){grid.innerHTML='';empty.classList.remove('hidden');return;}
  empty.classList.add('hidden');
  grid.innerHTML=clients.map(c=>`
    <div class="clicard" onclick="editCli(${c.id})">
      <div class="cliname">${c.name}</div>
      <div class="clisub">${c.email||'no email'}</div>
      <div class="cliinfo">${c.attn?'üë§ '+c.attn+'<br>':''}${c.phone?'üìû '+c.phone+'<br>':''}${c.addr?'üìç '+(c.addr||'').split('\n')[0]:''}</div>
      <div style="display:flex;gap:6px;margin-top:10px">
        <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();editCli(${c.id})">Edit</button>
        <button class="btn btn-danger btn-xs" onclick="event.stopPropagation();delCli(${c.id})">Remove</button>
      </div>
    </div>`).join('');
}

function openCliModal(c){
  ['cm-id','cm-name','cm-attn','cm-email','cm-phone','cm-addr'].forEach(id=>document.getElementById(id).value='');
  if(c){
    document.getElementById('cm-id').value=c.id;
    document.getElementById('cm-name').value=c.name||'';
    document.getElementById('cm-attn').value=c.attn||'';
    document.getElementById('cm-email').value=c.email||'';
    document.getElementById('cm-phone').value=c.phone||'';
    document.getElementById('cm-addr').value=c.addr||'';
  }
  document.getElementById('cli-modal').classList.remove('hidden');
  setTimeout(()=>document.getElementById('cm-name').focus(),100);
}
function editCli(id){const c=LS.arr('clients').find(x=>x.id===id);if(c)openCliModal(c);}
function closeCliModal(){document.getElementById('cli-modal').classList.add('hidden');}
function delCli(id){
  if(!confirm('Remove client?'))return;
  LS.set('clients',LS.arr('clients').filter(c=>c.id!==id));
  refreshSelects();renderCli();renderDash();
}
function saveCli(){
  const id=document.getElementById('cm-id').value;
  const name=document.getElementById('cm-name').value.trim();
  if(!name){toast('Name required','err');return;}
  const c={id:id?parseInt(id):Date.now(),name,attn:document.getElementById('cm-attn').value,email:document.getElementById('cm-email').value,phone:document.getElementById('cm-phone').value,addr:document.getElementById('cm-addr').value};
  const clients=LS.arr('clients');
  const idx=clients.findIndex(x=>x.id==c.id);
  if(idx>=0)clients[idx]=c;else clients.push(c);
  LS.set('clients',clients);
  refreshSelects();renderCli();closeCliModal();renderDash();
  toast(name+' saved','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// P&L
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPL(){
  const invs=LS.arr('documents').filter(d=>d.type==='INV');
  let totalRev=0,totalCost=0,totalNet=0,vendorOwed=0;

  const jobRows=invs.map(d=>{
    const cost=(d.costs||[]).reduce((s,c)=>s+parseFloat(c.amount||0),0);
    const gross=parseFloat(d.total||0)-cost;
    const net=gross*((d.malkoShare||100)/100);
    const pct=d.total>0?Math.round(gross/d.total*100):100;
    const unpaid=(d.costs||[]).filter(c=>!c.paid).reduce((s,c)=>s+parseFloat(c.amount||0),0);
    totalRev+=parseFloat(d.total||0);totalCost+=cost;totalNet+=net;vendorOwed+=unpaid;
    return`<tr>
      <td class="mono gold" style="font-size:11px">${d.docNumber}</td>
      <td style="font-size:12px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.clientName}</td>
      <td class="mono" style="font-size:11px">${fmtM(d.total)}</td>
      <td class="mono warn" style="font-size:11px">${cost>0?fmtM(cost):'‚Äî'}</td>
      <td>
        <div style="font-size:11px;font-family:var(--mono);color:${pct>=50?'var(--accent)':'var(--warn)'}">${pct}%</div>
        <div class="profit-bar" style="width:80px"><div class="profit-fill" style="width:${Math.min(pct,100)}%"></div></div>
      </td>
      <td class="mono accent" style="font-size:11px;font-weight:600">${fmtM(net)}</td>
      <td>${unpaid>0?`<span class="badge badge-pending">Owes ${fmtM(unpaid)}</span>`:`<span class="badge badge-paid">Clear</span>`}</td>
    </tr>`;
  });

  document.getElementById('pl-rev').textContent='RM '+totalRev.toLocaleString('en-MY',{minimumFractionDigits:0});
  document.getElementById('pl-cost').textContent='RM '+totalCost.toLocaleString('en-MY',{minimumFractionDigits:0});
  document.getElementById('pl-net').textContent='RM '+totalNet.toLocaleString('en-MY',{minimumFractionDigits:0});
  document.getElementById('pl-pay').textContent='RM '+vendorOwed.toLocaleString('en-MY',{minimumFractionDigits:0});
  document.getElementById('pl-job-body').innerHTML=jobRows.join('')||'<tr><td colspan="7" class="empty-sub" style="text-align:center;padding:20px">No invoices yet</td></tr>';

  // Monthly
  const monthly={};
  invs.forEach(d=>{
    if(!d.date)return;
    const k=d.date.substring(0,7);
    if(!monthly[k])monthly[k]={count:0,rev:0,cost:0,net:0};
    const cost=(d.costs||[]).reduce((s,c)=>s+parseFloat(c.amount||0),0);
    const gross=parseFloat(d.total||0)-cost;
    monthly[k].count++;monthly[k].rev+=parseFloat(d.total||0);
    monthly[k].cost+=cost;monthly[k].net+=gross*((d.malkoShare||100)/100);
  });
  const mkeys=Object.keys(monthly).sort().reverse();
  document.getElementById('pl-month-body').innerHTML=mkeys.length?mkeys.map(k=>{
    const m=monthly[k];
    return`<tr>
      <td>${new Date(k+'-01').toLocaleDateString('en-MY',{month:'long',year:'numeric'})}</td>
      <td>${m.count}</td>
      <td class="mono" style="font-size:11px">${fmtM(m.rev)}</td>
      <td class="mono warn" style="font-size:11px">${m.cost>0?fmtM(m.cost):'‚Äî'}</td>
      <td class="mono accent" style="font-size:11px;font-weight:600">${fmtM(m.net)}</td>
    </tr>`;
  }).join(''):'<tr><td colspan="5" style="text-align:center;padding:20px" class="muted">No data</td></tr>';
}

function exportPL(){
  const invs=LS.arr('documents').filter(d=>d.type==='INV');
  let csv='MALKO SOLUTIONS ‚Äî P&L / Income Summary (LHDN Form B)\nJR0170620-X | Muizz Zainuddin\n\n';
  csv+='Invoice No.,Date,Client,Description,Revenue (RM),Vendor Costs (RM),Gross Profit (RM),Malko Share (%),Net Income (RM),Status\n';
  invs.forEach(d=>{
    const cost=(d.costs||[]).reduce((s,c)=>s+parseFloat(c.amount||0),0);
    const gross=parseFloat(d.total||0)-cost;
    const net=gross*((d.malkoShare||100)/100);
    csv+=`${d.docNumber},${d.date},"${d.clientName}","${d.items.map(x=>x.desc).join('; ')}",${d.total.toFixed(2)},${cost.toFixed(2)},${gross.toFixed(2)},${d.malkoShare||100},${net.toFixed(2)},${d.status}\n`;
  });
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='MALKO_PL_LHDN.csv';a.click();
  toast('P&L exported for IRB ‚úì','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GAS_SCRIPT = `// MALKO HUB ‚Äî Google Apps Script Backend
// Paste this in Extensions > Apps Script > Save > Deploy > New Deployment > Web App

const SHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (action === 'save_doc') {
      const doc = payload.doc;
      const sheetName = doc.type === 'INV' ? 'Invoices' : 'Quotations';
      let sheet = ss.getSheetByName(sheetName);
      if (!sheet) sheet = ss.insertSheet(sheetName);
      
      // Add headers if empty
      if (sheet.getLastRow() === 0) {
        sheet.appendRow(['DocNumber','Type','Date','Client','Amount','Costs','Net','Status','CreatedAt','JSON']);
      }
      
      // Find existing row or append
      const data = sheet.getDataRange().getValues();
      let rowIdx = -1;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === doc.docNumber) { rowIdx = i + 1; break; }
      }
      
      const costs = (doc.costs || []).reduce((s, c) => s + (parseFloat(c.amount) || 0), 0);
      const gross = (parseFloat(doc.total) || 0) - costs;
      const net = gross * ((doc.malkoShare || 100) / 100);
      const row = [doc.docNumber, doc.type, doc.date, doc.clientName, doc.total, costs, net, doc.status, doc.createdAt, JSON.stringify(doc)];
      
      if (rowIdx > 0) sheet.getRange(rowIdx, 1, 1, row.length).setValues([row]);
      else sheet.appendRow(row);
      
      return ContentService.createTextOutput(JSON.stringify({ok:true})).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'get_all') {
      const result = { documents: [], clients: [] };
      ['Invoices','Quotations'].forEach(name => {
        const s = ss.getSheetByName(name);
        if (!s || s.getLastRow() < 2) return;
        const rows = s.getRange(2, 10, s.getLastRow()-1, 1).getValues();
        rows.forEach(r => { try { if(r[0]) result.documents.push(JSON.parse(r[0])); } catch(e){} });
      });
      const cs = ss.getSheetByName('Clients');
      if (cs && cs.getLastRow() > 1) {
        const crows = cs.getRange(2, 1, cs.getLastRow()-1, 6).getValues();
        crows.forEach(r => { if(r[0]) result.clients.push({id:r[0],name:r[1],attn:r[2],email:r[3],phone:r[4],addr:r[5]}); });
      }
      return ContentService.createTextOutput(JSON.stringify({ok:true,data:result})).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'save_client') {
      const c = payload.client;
      let sheet = ss.getSheetByName('Clients');
      if (!sheet) sheet = ss.insertSheet('Clients');
      if (sheet.getLastRow() === 0) sheet.appendRow(['ID','Name','Attn','Email','Phone','Address']);
      const data = sheet.getDataRange().getValues();
      let rowIdx = -1;
      for (let i = 1; i < data.length; i++) { if (data[i][0] == c.id) { rowIdx = i+1; break; } }
      const row = [c.id, c.name, c.attn, c.email, c.phone, c.addr];
      if (rowIdx > 0) sheet.getRange(rowIdx,1,1,row.length).setValues([row]);
      else sheet.appendRow(row);
      return ContentService.createTextOutput(JSON.stringify({ok:true})).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:'Unknown action'})).setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return doPost({postData:{contents:JSON.stringify({action:'get_all'})}});
}`;

function renderSettings(){
  document.getElementById('gas-code').textContent = GAS_SCRIPT;
  const url = LS.get('gs_url')||'';
  document.getElementById('gs-url').value = url;
  updateSyncUI();
}

function copyGAS(){
  navigator.clipboard.writeText(GAS_SCRIPT).then(()=>toast('Script copied!','ok'));
}

function saveGsUrl(){
  const url = document.getElementById('gs-url').value.trim();
  if(!url){toast('Paste the Apps Script URL first','err');return;}
  LS.set('gs_url', url);
  toast('URL saved ‚Äî testing connection...','info');
  testConnection(url);
}

async function testConnection(url){
  const status = document.getElementById('conn-status');
  status.textContent = '‚è≥ Testing connection...';
  try {
    const res = await fetch(url+'?action=get_all', {method:'GET'});
    const data = await res.json();
    if(data.ok){
      status.innerHTML = '<span style="color:var(--accent)">‚úì Connected! Syncing your data now...</span>';
      updateSyncUI('synced');
      if(data.data) mergeFromSheets(data.data);
      toast('Connected to Google Sheets ‚úì','ok');
    } else {
      status.innerHTML = '<span style="color:var(--warn)">‚úó Error: '+data.error+'</span>';
      updateSyncUI('error');
    }
  } catch(e) {
    status.innerHTML = '<span style="color:var(--warn)">‚úó Could not reach URL. Check deployment & CORS settings.</span>';
    updateSyncUI('error');
  }
}

async function syncNow(){
  const url = LS.get('gs_url');
  if(!url){toast('Set up sync URL first','err');nav('settings',document.querySelector('[onclick*=settings]'));return;}
  updateSyncUI('syncing');
  toast('Syncing...','info');
  try {
    const res = await fetch(url+'?action=get_all');
    const data = await res.json();
    if(data.ok && data.data){
      mergeFromSheets(data.data);
      updateSyncUI('synced');
      toast('Synced from Google Sheets ‚úì','ok');
      renderDash();
    } else {
      updateSyncUI('error');
      toast('Sync failed','err');
    }
  } catch(e){
    updateSyncUI('error');
    toast('Connection failed','err');
  }
}

function mergeFromSheets(data){
  if(data.documents && data.documents.length){
    const local = LS.arr('documents');
    const merged = [...local];
    data.documents.forEach(d=>{
      if(!merged.find(x=>x.docNumber===d.docNumber)) merged.push(d);
    });
    LS.set('documents', merged);
  }
  if(data.clients && data.clients.length){
    const local = LS.arr('clients');
    const merged = [...local];
    data.clients.forEach(c=>{
      if(!merged.find(x=>x.id==c.id)) merged.push(c);
    });
    LS.set('clients', merged);
    refreshSelects();
  }
}

async function syncToSheets(doc){
  const url = LS.get('gs_url');
  if(!url) return;
  updateSyncUI('syncing');
  try {
    await fetch(url, {
      method:'POST',
      body: JSON.stringify({action:'save_doc', doc}),
    });
    updateSyncUI('synced');
    LS.set('last_sync', new Date().toISOString());
  } catch(e){
    updateSyncUI('error');
  }
}

function updateSyncUI(state){
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  const url = LS.get('gs_url');
  if(!state) state = url ? 'synced' : 'offline';
  dot.className = 'sync-dot ' + (state==='synced'?'synced':state==='syncing'?'syncing':state==='error'?'error':'');
  const last = LS.get('last_sync');
  const lastStr = last ? new Date(last).toLocaleTimeString('en-MY',{hour:'2-digit',minute:'2-digit'}) : '';
  lbl.textContent = state==='synced'?(lastStr?'Synced '+lastStr:'Synced'):state==='syncing'?'Syncing...':state==='error'?'Sync error':'Not connected';
}

function exportLocalJSON(){
  const data={documents:LS.arr('documents'),clients:LS.arr('clients'),exported:new Date().toISOString()};
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data,null,2));
  a.download='malko_backup_'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  toast('Backup downloaded ‚úì','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type='ok'){
  const t=document.getElementById('toast');
  t.textContent=(type==='ok'?'‚úì ':type==='err'?'‚úï ':'‚Ñπ ')+msg;
  t.className='toast '+type+' show';
  setTimeout(()=>{t.className='toast';},3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  seedData();

  const today=new Date().toISOString().split('T')[0];
  document.getElementById('q-date').value=today;
  document.getElementById('i-date').value=today;
  const due=new Date();due.setDate(due.getDate()+30);
  document.getElementById('i-due').value=due.toISOString().split('T')[0];

  document.getElementById('q-num').value=nextNum('q');
  document.getElementById('quo-pill').textContent=document.getElementById('q-num').value;
  document.getElementById('i-num').value=nextNum('i');
  document.getElementById('inv-pill').textContent=document.getElementById('i-num').value;

  addLI('q'); addLI('i');
  refreshSelects();
  renderDash();
  updateSyncUI();

  // Auto-sync on load if configured
  const url=LS.get('gs_url');
  if(url) syncNow();
});

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closePDF();closeCliModal();}
});

// Print styles
const style=document.createElement('style');
style.textContent=`@media print{body *{display:none!important}.pdoc{display:block!important}.pdoc *{display:revert!important}@page{margin:0.4in;size:A4}}`;
document.head.appendChild(style);
</script>
</body>
</html>
