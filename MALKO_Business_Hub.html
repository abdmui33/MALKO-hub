<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Malko Solutions ‚Äî Business Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --teal: #0F7B65;
    --teal-dark: #085445;
    --teal-light: #14A886;
    --teal-xlight: #D0EEE8;
    --teal-pale: #EAF7F4;
    --ink: #0D1F1A;
    --ink-mid: #2D4A43;
    --ink-soft: #5A7A72;
    --ink-muted: #8AABA3;
    --cream: #F7FBF9;
    --white: #FFFFFF;
    --warn: #E85D3A;
    --warn-pale: #FEF0EC;
    --gold: #C9973A;
    --gold-pale: #FDF6E8;
    --border: #D4E9E3;
    --shadow: 0 2px 12px rgba(15,123,101,0.08);
    --shadow-lg: 0 8px 40px rgba(15,123,101,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== LAYOUT ===== */
  .app { display: flex; min-height: 100vh; }

  /* ===== SIDEBAR ===== */
  .sidebar {
    width: 240px;
    background: var(--ink);
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    left: 0; top: 0;
    z-index: 100;
    overflow-y: auto;
  }

  .sidebar-brand {
    padding: 28px 24px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }

  .sidebar-logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 20px;
    color: var(--teal-light);
    letter-spacing: -0.5px;
  }

  .sidebar-tagline {
    font-size: 10px;
    color: var(--ink-muted);
    margin-top: 3px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .sidebar-nav { padding: 16px 0; flex: 1; }

  .nav-section-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--ink-muted);
    padding: 12px 24px 6px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 24px;
    cursor: pointer;
    transition: all 0.15s;
    color: #8AABA3;
    font-size: 14px;
    font-weight: 400;
    border-left: 3px solid transparent;
    text-decoration: none;
  }

  .nav-item:hover { color: var(--white); background: rgba(255,255,255,0.04); }
  .nav-item.active { color: var(--white); background: rgba(20,168,134,0.12); border-left-color: var(--teal-light); font-weight: 500; }

  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  .sidebar-bottom {
    padding: 16px 24px;
    border-top: 1px solid rgba(255,255,255,0.06);
    font-size: 11px;
    color: var(--ink-muted);
  }

  .sidebar-bottom .reg { font-family: 'DM Mono', monospace; font-size: 10px; }

  /* ===== MAIN CONTENT ===== */
  .main { margin-left: 240px; flex: 1; }

  .page-header {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 24px 36px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .page-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 22px;
    color: var(--ink);
    letter-spacing: -0.5px;
  }

  .page-subtitle { font-size: 13px; color: var(--ink-soft); margin-top: 2px; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 9px 18px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    text-decoration: none;
  }

  .btn-primary { background: var(--teal); color: white; }
  .btn-primary:hover { background: var(--teal-dark); transform: translateY(-1px); box-shadow: var(--shadow); }

  .btn-secondary { background: var(--white); color: var(--teal); border: 1.5px solid var(--border); }
  .btn-secondary:hover { border-color: var(--teal); background: var(--teal-pale); }

  .btn-ghost { background: transparent; color: var(--ink-soft); }
  .btn-ghost:hover { background: var(--cream); }

  .btn-danger { background: var(--warn); color: white; }
  .btn-danger:hover { background: #c44d2c; }

  .btn-sm { padding: 6px 12px; font-size: 12px; }

  .page-content { padding: 32px 36px; }

  /* ===== DASHBOARD ===== */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }

  .stat-card {
    background: var(--white);
    border-radius: 12px;
    padding: 20px 24px;
    border: 1px solid var(--border);
    transition: box-shadow 0.2s;
  }
  .stat-card:hover { box-shadow: var(--shadow); }

  .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--ink-muted); font-family: 'DM Mono', monospace; }
  .stat-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 700; color: var(--ink); margin-top: 6px; }
  .stat-sub { font-size: 12px; color: var(--ink-soft); margin-top: 4px; }
  .stat-teal .stat-value { color: var(--teal); }
  .stat-gold .stat-value { color: var(--gold); }
  .stat-warn .stat-value { color: var(--warn); }

  .recent-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

  .card {
    background: var(--white);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 14px;
  }

  /* ===== TABLES ===== */
  .data-table { width: 100%; border-collapse: collapse; }

  .data-table th {
    background: var(--cream);
    padding: 11px 16px;
    text-align: left;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--ink-muted);
    border-bottom: 1px solid var(--border);
    font-weight: 400;
  }

  .data-table td {
    padding: 13px 16px;
    font-size: 13px;
    border-bottom: 1px solid var(--border);
    color: var(--ink);
    vertical-align: middle;
  }

  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: var(--teal-pale); }

  /* ===== BADGES ===== */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 9px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    font-family: 'DM Mono', monospace;
  }

  .badge-quo { background: #EEF2FF; color: #4F46E5; }
  .badge-inv { background: var(--gold-pale); color: var(--gold); }
  .badge-paid { background: #ECFDF5; color: #059669; }
  .badge-pending { background: var(--warn-pale); color: var(--warn); }
  .badge-draft { background: var(--cream); color: var(--ink-muted); border: 1px solid var(--border); }

  /* ===== FORM ===== */
  .form-section {
    background: var(--white);
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-bottom: 20px;
    overflow: hidden;
  }

  .form-section-header {
    padding: 14px 20px;
    background: var(--cream);
    border-bottom: 1px solid var(--border);
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 13px;
    color: var(--teal-dark);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-section-body { padding: 20px; }

  .form-grid { display: grid; gap: 16px; }
  .form-grid-2 { grid-template-columns: 1fr 1fr; }
  .form-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }

  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.span-2 { grid-column: span 2; }
  .form-group.span-3 { grid-column: span 3; }
  .form-group.span-4 { grid-column: span 4; }

  label {
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--ink-soft);
    font-family: 'DM Mono', monospace;
  }

  input, textarea, select {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 7px;
    background: var(--white);
    color: var(--ink);
    transition: border-color 0.15s, box-shadow 0.15s;
    width: 100%;
    outline: none;
  }

  input:focus, textarea:focus, select:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(15,123,101,0.1);
  }

  textarea { resize: vertical; min-height: 70px; }

  /* ===== LINE ITEMS ===== */
  .line-items-header {
    display: grid;
    grid-template-columns: 40px 1fr 120px 80px 130px 40px;
    gap: 8px;
    padding: 8px 16px;
    background: var(--cream);
    border-bottom: 1px solid var(--border);
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .line-item-row {
    display: grid;
    grid-template-columns: 40px 1fr 120px 80px 130px 40px;
    gap: 8px;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
    align-items: center;
  }

  .line-item-row:last-child { border-bottom: none; }

  .line-num {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--ink-muted);
    text-align: center;
  }

  .line-item-row input {
    padding: 7px 10px;
    font-size: 13px;
  }

  .remove-btn {
    width: 28px; height: 28px;
    border-radius: 6px;
    border: 1.5px solid var(--border);
    background: var(--white);
    color: var(--ink-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.15s;
  }

  .remove-btn:hover { border-color: var(--warn); color: var(--warn); background: var(--warn-pale); }

  .totals-section {
    padding: 16px 20px;
    background: var(--cream);
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
  }

  .totals-box { min-width: 280px; }

  .totals-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    font-size: 13px;
    color: var(--ink-soft);
  }

  .totals-row.total {
    border-top: 2px solid var(--teal);
    margin-top: 8px;
    padding-top: 10px;
    font-weight: 600;
    font-size: 16px;
    color: var(--ink);
  }

  .totals-row.total .amount { font-family: 'Syne', sans-serif; font-size: 20px; color: var(--teal); }
  .amount { font-family: 'DM Mono', monospace; }

  /* ===== ACTIONS BAR ===== */
  .actions-bar {
    display: flex;
    gap: 10px;
    padding: 20px 36px;
    background: var(--white);
    border-top: 1px solid var(--border);
    position: sticky;
    bottom: 0;
    z-index: 40;
  }

  /* ===== DOCUMENT PREVIEW ===== */
  .preview-overlay {
    position: fixed;
    inset: 0;
    background: rgba(13, 31, 26, 0.7);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    padding: 24px;
    overflow-y: auto;
  }

  .preview-wrapper {
    position: relative;
    width: 100%;
    max-width: 820px;
  }

  .preview-controls {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-bottom: 12px;
  }

  /* ===== PRINT DOCUMENT ===== */
  .print-doc {
    background: white;
    padding: 48px 52px;
    font-family: 'DM Sans', sans-serif;
    color: #1A1A1A;
    border-radius: 4px;
    min-height: 1000px;
  }

  .print-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 36px; }

  .print-company-name {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 26px;
    color: #0F7B65;
    letter-spacing: -1px;
  }

  .print-company-tagline { font-size: 11px; color: #8AABA3; margin-top: 2px; }
  .print-company-info { font-size: 11px; color: #5A7A72; margin-top: 8px; line-height: 1.7; }

  .print-doc-type {
    text-align: right;
  }

  .print-doc-type-label {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 32px;
    color: #0F7B65;
    letter-spacing: -1px;
    text-transform: uppercase;
  }

  .print-doc-meta { font-family: 'DM Mono', monospace; font-size: 11px; color: #5A7A72; margin-top: 6px; line-height: 1.8; text-align: right; }
  .print-doc-meta strong { color: #1A1A1A; }

  .print-divider { height: 2px; background: linear-gradient(90deg, #0F7B65, #D0EEE8); margin: 24px 0; border: none; }

  .print-bill-to { margin-bottom: 28px; }
  .print-bill-label { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: #0F7B65; margin-bottom: 6px; }
  .print-bill-name { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 15px; color: #1A1A1A; }
  .print-bill-info { font-size: 12px; color: #5A7A72; margin-top: 3px; line-height: 1.6; }

  .print-items { width: 100%; border-collapse: collapse; margin-bottom: 0; }

  .print-items thead tr {
    background: #0F7B65;
  }

  .print-items th {
    padding: 10px 14px;
    text-align: left;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: white;
    font-weight: 400;
  }

  .print-items th:last-child, .print-items th:nth-last-child(2), .print-items th:nth-last-child(3) { text-align: right; }

  .print-items td {
    padding: 11px 14px;
    font-size: 12.5px;
    border-bottom: 1px solid #E8F0EE;
    vertical-align: top;
  }

  .print-items td:last-child, .print-items td:nth-last-child(2), .print-items td:nth-last-child(3) {
    text-align: right;
    font-family: 'DM Mono', monospace;
  }

  .print-items tr:nth-child(even) td { background: #F7FBF9; }

  .print-totals { display: flex; justify-content: flex-end; margin-top: 0; }
  .print-totals-box { min-width: 260px; background: #F7FBF9; padding: 16px 18px; }

  .print-totals-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; color: #5A7A72; }
  .print-totals-row.grand { border-top: 2px solid #0F7B65; margin-top: 8px; padding-top: 10px; color: #1A1A1A; font-weight: 600; font-size: 15px; }
  .print-totals-row.grand .print-amount { font-family: 'Syne', monospace; font-size: 18px; color: #0F7B65; }
  .print-amount { font-family: 'DM Mono', monospace; }

  .print-footer {
    margin-top: 36px;
    padding-top: 20px;
    border-top: 1px solid #E8F0EE;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }

  .print-terms { font-size: 11px; color: #8AABA3; max-width: 340px; line-height: 1.6; }
  .print-terms strong { color: #5A7A72; }
  .print-bank { text-align: right; }
  .print-bank-label { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: #0F7B65; margin-bottom: 4px; }
  .print-bank-info { font-size: 11px; color: #5A7A72; line-height: 1.7; font-family: 'DM Mono', monospace; }

  .print-sig { margin-top: 40px; text-align: right; }
  .print-sig-line { width: 200px; height: 1px; background: #ccc; margin-left: auto; margin-bottom: 6px; }
  .print-sig-name { font-size: 12px; color: #5A7A72; }

  /* ===== CLIENT MANAGER ===== */
  .client-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .client-card {
    background: var(--white);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .client-card:hover { border-color: var(--teal); box-shadow: var(--shadow); transform: translateY(-2px); }
  .client-name { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 14px; color: var(--ink); margin-bottom: 4px; }
  .client-ref { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--ink-muted); margin-bottom: 8px; }
  .client-info { font-size: 12px; color: var(--ink-soft); line-height: 1.6; }

  /* ===== TRACKER ===== */
  .tracker-filters { display: flex; gap: 8px; margin-bottom: 20px; }

  .filter-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: 1.5px solid var(--border);
    background: var(--white);
    color: var(--ink-soft);
    transition: all 0.15s;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.5px;
  }

  .filter-chip.active { background: var(--teal); border-color: var(--teal); color: white; }
  .filter-chip:hover:not(.active) { border-color: var(--teal); color: var(--teal); }

  /* ===== MODAL ===== */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(13,31,26,0.6);
    z-index: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal {
    background: var(--white);
    border-radius: 14px;
    padding: 28px;
    width: 480px;
    max-width: 95vw;
    box-shadow: var(--shadow-lg);
  }

  .modal-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 18px; margin-bottom: 20px; color: var(--ink); }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--ink);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: var(--shadow-lg);
  }

  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-left: 4px solid var(--teal-light); }
  .toast.error { border-left: 4px solid var(--warn); }

  /* ===== EMPTY STATE ===== */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--ink-muted);
  }

  .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state-title { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 18px; color: var(--ink-soft); margin-bottom: 8px; }
  .empty-state-sub { font-size: 13px; }

  /* ===== HIDDEN / PRINT ===== */
  .hidden { display: none !important; }

  @media print {
    body * { display: none !important; }
    .print-doc { display: block !important; }
    .print-doc * { display: revert !important; }
    @page { margin: 0.5in; }
  }

  /* Smooth transitions for page switching */
  .page { animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* Number input no spinner */
  input[type=number]::-webkit-inner-spin-button { opacity: 0.3; }

  .doc-number-badge {
    display: inline-flex;
    align-items: center;
    background: var(--teal-pale);
    border: 1.5px solid var(--teal-xlight);
    border-radius: 6px;
    padding: 4px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--teal-dark);
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  .income-bar {
    display: flex;
    gap: 4px;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
  }
  .income-bar-fill { background: var(--teal); border-radius: 3px; transition: width 0.5s; }
  .income-bar-rest { background: var(--border); flex: 1; }
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-brand">
      <div class="sidebar-logo">malko<span style="color: var(--teal-xlight)">‚Ä∫</span></div>
      <div class="sidebar-tagline">Business Hub</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Overview</div>
      <div class="nav-item active" onclick="showPage('dashboard', this)">
        <span class="nav-icon">‚¨°</span> Dashboard
      </div>

      <div class="nav-section-label" style="margin-top:8px">Documents</div>
      <div class="nav-item" onclick="showPage('new-quotation', this)">
        <span class="nav-icon">‚óà</span> New Quotation
      </div>
      <div class="nav-item" onclick="showPage('new-invoice', this)">
        <span class="nav-icon">‚óâ</span> New Invoice
      </div>

      <div class="nav-section-label" style="margin-top:8px">Records</div>
      <div class="nav-item" onclick="showPage('tracker', this)">
        <span class="nav-icon">‚ó´</span> Job Tracker
      </div>
      <div class="nav-item" onclick="showPage('clients', this)">
        <span class="nav-icon">‚óé</span> Clients
      </div>

      <div class="nav-section-label" style="margin-top:8px">Finance</div>
      <div class="nav-item" onclick="showPage('reports', this)">
        <span class="nav-icon">‚ó∞</span> P&amp;L Report
      </div>
    </div>
    <div class="sidebar-bottom">
      <div style="font-weight:600; color: var(--white); font-size:12px; margin-bottom:4px">Muizz Zainuddin</div>
      <div style="color: var(--ink-soft); font-size:11px">Alliance Director</div>
      <div class="reg" style="margin-top:6px">JR0170620-X</div>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="main">

    <!-- ===== DASHBOARD ===== -->
    <div id="page-dashboard" class="page">
      <div class="page-header">
        <div>
          <div class="page-title">Good day, Muizz üëã</div>
          <div class="page-subtitle" id="dashboard-date"></div>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-secondary" onclick="showPage('new-quotation', document.querySelector('[onclick*=new-quotation]'))">+ New Quotation</button>
          <button class="btn btn-primary" onclick="showPage('new-invoice', document.querySelector('[onclick*=new-invoice]'))">+ New Invoice</button>
        </div>
      </div>
      <div class="page-content">
        <div class="stats-grid">
          <div class="stat-card stat-teal">
            <div class="stat-label">Total Invoiced</div>
            <div class="stat-value" id="stat-invoiced">RM 0</div>
            <div class="stat-sub" id="stat-invoiced-count">0 invoices</div>
          </div>
          <div class="stat-card stat-gold">
            <div class="stat-label">Outstanding</div>
            <div class="stat-value" id="stat-outstanding">RM 0</div>
            <div class="stat-sub" id="stat-outstanding-count">0 pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Quotations Sent</div>
            <div class="stat-value" id="stat-quotes">0</div>
            <div class="stat-sub" id="stat-quotes-sub">this year</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Clients</div>
            <div class="stat-value" id="stat-clients">0</div>
            <div class="stat-sub">in address book</div>
          </div>
        </div>
        <div class="recent-section">
          <div class="card">
            <div class="card-header">
              Recent Invoices
              <button class="btn btn-ghost btn-sm" onclick="showPage('tracker', document.querySelector('[onclick*=tracker]'))">View all ‚Üí</button>
            </div>
            <table class="data-table" id="recent-invoices-table">
              <thead><tr><th>No.</th><th>Client</th><th>Amount</th><th>Status</th></tr></thead>
              <tbody id="recent-invoices-body"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-header">
              Recent Quotations
              <button class="btn btn-ghost btn-sm" onclick="showPage('tracker', document.querySelector('[onclick*=tracker]'))">View all ‚Üí</button>
            </div>
            <table class="data-table" id="recent-quotes-table">
              <thead><tr><th>No.</th><th>Client</th><th>Amount</th><th>Date</th></tr></thead>
              <tbody id="recent-quotes-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== NEW QUOTATION ===== -->
    <div id="page-new-quotation" class="page hidden">
      <div class="page-header">
        <div>
          <div class="page-title">New Quotation</div>
          <div class="page-subtitle">Create a professional quotation for your client</div>
        </div>
        <div class="doc-number-badge" id="quo-number-display">QUO-117</div>
      </div>
      <div class="page-content" style="padding-bottom:120px">

        <div class="form-section">
          <div class="form-section-header">üìã Quotation Details</div>
          <div class="form-section-body">
            <div class="form-grid form-grid-3">
              <div class="form-group">
                <label>Document Number</label>
                <input type="text" id="quo-number" value="QUO-117" oninput="document.getElementById('quo-number-display').textContent=this.value">
              </div>
              <div class="form-group">
                <label>Quotation Date</label>
                <input type="date" id="quo-date">
              </div>
              <div class="form-group">
                <label>Validity (Days)</label>
                <input type="number" id="quo-validity" value="14" min="1">
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-header">üè¢ Client / Bill To</div>
          <div class="form-section-body">
            <div class="form-grid form-grid-2" style="margin-bottom:16px">
              <div class="form-group">
                <label>Quick Select Client</label>
                <select id="quo-client-select" onchange="fillClientQuo(this.value)">
                  <option value="">‚Äî Select existing client ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label>Company / Client Name *</label>
                <input type="text" id="quo-client-name" placeholder="e.g. Techmile Resources Sdn Bhd">
              </div>
              <div class="form-group">
                <label>Attention (Person)</label>
                <input type="text" id="quo-client-attn" placeholder="e.g. Ahmad / En. Hafiz">
              </div>
              <div class="form-group span-2">
                <label>Address</label>
                <textarea id="quo-client-addr" placeholder="Full mailing address" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="quo-client-email" placeholder="client@company.com">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="text" id="quo-client-phone" placeholder="01x-xxxx xxxx">
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-header">üì¶ Line Items</div>
          <div class="line-items-header">
            <span>#</span><span>Description</span><span style="text-align:right">Unit Price (RM)</span><span style="text-align:right">Qty</span><span style="text-align:right">Amount (RM)</span><span></span>
          </div>
          <div id="quo-items"></div>
          <div style="padding:12px 16px; border-top:1px solid var(--border)">
            <button class="btn btn-secondary btn-sm" onclick="addItem('quo')">+ Add Item</button>
          </div>
          <div class="totals-section">
            <div class="totals-box">
              <div class="totals-row"><span>Subtotal</span><span class="amount" id="quo-subtotal">RM 0.00</span></div>
              <div class="totals-row">
                <span>Discount</span>
                <span style="display:flex;align-items:center;gap:6px">
                  <input type="number" id="quo-discount" value="0" min="0" style="width:70px;padding:4px 8px;font-size:12px" onchange="calcTotals('quo')">
                </span>
              </div>
              <div class="totals-row">
                <span>Tax Rate (%)</span>
                <span style="display:flex;align-items:center;gap:6px">
                  <input type="number" id="quo-tax" value="0" min="0" max="100" style="width:70px;padding:4px 8px;font-size:12px" onchange="calcTotals('quo')">
                </span>
              </div>
              <div class="totals-row"><span>Tax Amount</span><span class="amount" id="quo-tax-amt">RM 0.00</span></div>
              <div class="totals-row total">
                <span>TOTAL</span>
                <span class="amount" id="quo-total">RM 0.00</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-header">üìù Notes & Terms</div>
          <div class="form-section-body">
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label>Notes / Scope Details</label>
                <textarea id="quo-notes" placeholder="Additional notes, scope of work, delivery details..."></textarea>
              </div>
              <div class="form-group">
                <label>Terms & Conditions</label>
                <textarea id="quo-terms">Payment Terms: 50% Upon Order, 50% Upon Delivery.
Acceptance confirmed by issuance of a Purchase Order.
This is a computer-generated document; no signature required.</textarea>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="actions-bar">
        <button class="btn btn-primary" onclick="saveAndPreview('quo')">üëÅ Preview &amp; Print</button>
        <button class="btn btn-secondary" onclick="saveDoc('quo')">üíæ Save Quotation</button>
        <button class="btn btn-secondary" onclick="exportDocXLSX('quo')">üìä Export to Excel</button>
        <button class="btn btn-ghost" onclick="resetForm('quo')">üóë Clear Form</button>
      </div>
    </div>

    <!-- ===== NEW INVOICE ===== -->
    <div id="page-new-invoice" class="page hidden">
      <div class="page-header">
        <div>
          <div class="page-title">New Invoice</div>
          <div class="page-subtitle">Generate a payment invoice for your client</div>
        </div>
        <div class="doc-number-badge" id="inv-number-display">INV-116</div>
      </div>
      <div class="page-content" style="padding-bottom:120px">

        <div class="form-section">
          <div class="form-section-header">üìã Invoice Details</div>
          <div class="form-section-body">
            <div class="form-grid form-grid-4">
              <div class="form-group">
                <label>Invoice Number</label>
                <input type="text" id="inv-number" value="INV-116" oninput="document.getElementById('inv-number-display').textContent=this.value">
              </div>
              <div class="form-group">
                <label>Invoice Date</label>
                <input type="date" id="inv-date">
              </div>
              <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="inv-due">
              </div>
              <div class="form-group">
                <label>Ref: Quotation No.</label>
                <input type="text" id="inv-ref-quo" placeholder="QUO-xxx (optional)">
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-header">üè¢ Client / Bill To</div>
          <div class="form-section-body">
            <div class="form-grid form-grid-2" style="margin-bottom:16px">
              <div class="form-group">
                <label>Quick Select Client</label>
                <select id="inv-client-select" onchange="fillClientInv(this.value)">
                  <option value="">‚Äî Select existing client ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label>Company / Client Name *</label>
                <input type="text" id="inv-client-name" placeholder="e.g. Techmile Resources Sdn Bhd">
              </div>
              <div class="form-group">
                <label>Attention (Person)</label>
                <input type="text" id="inv-client-attn" placeholder="e.g. Ahmad / En. Hafiz">
              </div>
              <div class="form-group span-2">
                <label>Address</label>
                <textarea id="inv-client-addr" placeholder="Full mailing address" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="inv-client-email" placeholder="client@company.com">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="text" id="inv-client-phone" placeholder="01x-xxxx xxxx">
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-header">üì¶ Line Items</div>
          <div class="line-items-header">
            <span>#</span><span>Description</span><span style="text-align:right">Unit Price (RM)</span><span style="text-align:right">Qty</span><span style="text-align:right">Amount (RM)</span><span></span>
          </div>
          <div id="inv-items"></div>
          <div style="padding:12px 16px; border-top:1px solid var(--border)">
            <button class="btn btn-secondary btn-sm" onclick="addItem('inv')">+ Add Item</button>
          </div>
          <div class="totals-section">
            <div class="totals-box">
              <div class="totals-row"><span>Subtotal</span><span class="amount" id="inv-subtotal">RM 0.00</span></div>
              <div class="totals-row">
                <span>Discount (RM)</span>
                <input type="number" id="inv-discount" value="0" min="0" style="width:80px;padding:4px 8px;font-size:12px" onchange="calcTotals('inv')">
              </div>
              <div class="totals-row">
                <span>Tax Rate (%)</span>
                <input type="number" id="inv-tax" value="0" min="0" max="100" style="width:80px;padding:4px 8px;font-size:12px" onchange="calcTotals('inv')">
              </div>
              <div class="totals-row"><span>Tax Amount</span><span class="amount" id="inv-tax-amt">RM 0.00</span></div>
              <div class="totals-row total">
                <span>TOTAL</span>
                <span class="amount" id="inv-total">RM 0.00</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-header">üìù Notes & Payment Info</div>
          <div class="form-section-body">
            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label>Notes / Description of Work</label>
                <textarea id="inv-notes" placeholder="Description of goods/services provided..."></textarea>
              </div>
              <div class="form-group">
                <label>Payment Terms</label>
                <textarea id="inv-terms">Payment due within 30 days of invoice date.
Bank: CIMB Bank Berhad
Account Name: MALKO SOLUTIONS
Account No: 8606011612
This is a computer-generated document; no signature required.</textarea>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="actions-bar">
        <button class="btn btn-primary" onclick="saveAndPreview('inv')">üëÅ Preview &amp; Print</button>
        <button class="btn btn-secondary" onclick="saveDoc('inv')">üíæ Save Invoice</button>
        <button class="btn btn-secondary" onclick="exportDocXLSX('inv')">üìä Export to Excel</button>
        <button class="btn btn-ghost" onclick="resetForm('inv')">üóë Clear Form</button>
      </div>
    </div>

    <!-- ===== JOB TRACKER ===== -->
    <div id="page-tracker" class="page hidden">
      <div class="page-header">
        <div>
          <div class="page-title">Job Tracker</div>
          <div class="page-subtitle">All quotations, invoices and their statuses</div>
        </div>
        <button class="btn btn-secondary" onclick="exportTrackerXLSX()">üìä Export to Excel</button>
      </div>
      <div class="page-content">
        <div class="tracker-filters" id="tracker-filters">
          <div class="filter-chip active" onclick="filterTracker('all', this)">All</div>
          <div class="filter-chip" onclick="filterTracker('QUO', this)">Quotations</div>
          <div class="filter-chip" onclick="filterTracker('INV', this)">Invoices</div>
          <div class="filter-chip" onclick="filterTracker('paid', this)">Paid</div>
          <div class="filter-chip" onclick="filterTracker('pending', this)">Pending</div>
        </div>
        <div class="card">
          <table class="data-table" id="tracker-table">
            <thead>
              <tr>
                <th>Doc No.</th>
                <th>Type</th>
                <th>Client</th>
                <th>Description</th>
                <th>Amount (RM)</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tracker-body"></tbody>
          </table>
          <div id="tracker-empty" class="empty-state hidden">
            <div class="empty-state-icon">‚ó´</div>
            <div class="empty-state-title">No documents yet</div>
            <div class="empty-state-sub">Create a quotation or invoice to get started</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== CLIENTS ===== -->
    <div id="page-clients" class="page hidden">
      <div class="page-header">
        <div>
          <div class="page-title">Client Address Book</div>
          <div class="page-subtitle">Manage your clients for quick document filling</div>
        </div>
        <button class="btn btn-primary" onclick="openClientModal()">+ Add Client</button>
      </div>
      <div class="page-content">
        <div class="client-grid" id="client-grid"></div>
        <div id="clients-empty" class="empty-state hidden">
          <div class="empty-state-icon">‚óé</div>
          <div class="empty-state-title">No clients saved yet</div>
          <div class="empty-state-sub">Add your frequent clients to speed up document creation</div>
        </div>
      </div>
    </div>

    <!-- ===== P&L REPORT ===== -->
    <div id="page-reports" class="page hidden">
      <div class="page-header">
        <div>
          <div class="page-title">P&amp;L Summary</div>
          <div class="page-subtitle">Income summary for IRB / Lembaga Hasil Dalam Negeri reporting</div>
        </div>
        <button class="btn btn-secondary" onclick="exportPLXLSX()">üìä Export for IRB</button>
      </div>
      <div class="page-content">
        <div class="stats-grid" style="grid-template-columns: repeat(3,1fr)">
          <div class="stat-card stat-teal">
            <div class="stat-label">Gross Revenue</div>
            <div class="stat-value" id="pl-revenue">RM 0</div>
            <div class="stat-sub">Total invoiced (paid)</div>
          </div>
          <div class="stat-card stat-gold">
            <div class="stat-label">Conversion Rate</div>
            <div class="stat-value" id="pl-conv">0%</div>
            <div class="stat-sub">Quotes ‚Üí Invoices</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Outstanding</div>
            <div class="stat-value" id="pl-outstanding">RM 0</div>
            <div class="stat-sub">Pending payment</div>
          </div>
        </div>

        <div class="card" style="margin-top:20px">
          <div class="card-header">Monthly Revenue Breakdown</div>
          <table class="data-table" id="pl-table">
            <thead>
              <tr><th>Month</th><th>Invoices Issued</th><th>Amount Invoiced</th><th>Paid</th><th>Pending</th></tr>
            </thead>
            <tbody id="pl-body"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:20px">
          <div class="card-header">Invoice Detail (for IRB)</div>
          <table class="data-table">
            <thead>
              <tr><th>Invoice No.</th><th>Date</th><th>Client</th><th>Description</th><th>Amount (RM)</th><th>Status</th></tr>
            </thead>
            <tbody id="pl-detail-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- end .main -->
</div><!-- end .app -->

<!-- ===== PREVIEW OVERLAY ===== -->
<div class="preview-overlay hidden" id="preview-overlay">
  <div class="preview-wrapper">
    <div class="preview-controls">
      <button class="btn btn-secondary" onclick="window.print()">üñ® Print / Save PDF</button>
      <button class="btn btn-primary" onclick="exportDocXLSX(currentPreviewType)">üìä Export Excel</button>
      <button class="btn btn-ghost" style="color:white" onclick="closePreview()">‚úï Close</button>
    </div>
    <div id="print-doc-container"></div>
  </div>
</div>

<!-- ===== CLIENT MODAL ===== -->
<div class="modal-overlay hidden" id="client-modal">
  <div class="modal">
    <div class="modal-title">üë§ Add / Edit Client</div>
    <div class="form-grid" style="gap:12px">
      <input type="hidden" id="client-id">
      <div class="form-group">
        <label>Company / Client Name *</label>
        <input type="text" id="cm-name" placeholder="Full company name">
      </div>
      <div class="form-group">
        <label>Contact Person</label>
        <input type="text" id="cm-attn" placeholder="Name / attention">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="cm-email" placeholder="email@company.com">
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="text" id="cm-phone" placeholder="01x-xxxx xxxx">
      </div>
      <div class="form-group">
        <label>Address</label>
        <textarea id="cm-addr" rows="3" placeholder="Full mailing address"></textarea>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeClientModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveClient()">Save Client</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== DATA STORE =====
const DB = {
  get: (key) => JSON.parse(localStorage.getItem('malko_' + key) || 'null'),
  set: (key, val) => localStorage.setItem('malko_' + key, JSON.stringify(val)),
  getArr: (key) => JSON.parse(localStorage.getItem('malko_' + key) || '[]'),
};

// ===== STATE =====
let currentPreviewType = 'quo';

// Counters
function getNextNum(type) {
  const docs = DB.getArr('documents');
  const prefix = type === 'quo' ? 'QUO-' : 'INV-';
  const nums = docs.filter(d => d.docNumber && d.docNumber.startsWith(prefix))
    .map(d => parseInt(d.docNumber.replace(prefix, '')) || 0);
  // Start from 117 for QUO (continuing your existing sequence) and 116 for INV
  const base = type === 'quo' ? 117 : 116;
  const max = nums.length ? Math.max(...nums) : base - 1;
  return prefix + (max + 1);
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('quo-date').value = today;
  document.getElementById('inv-date').value = today;

  // Set due date +30 days
  const due = new Date(); due.setDate(due.getDate() + 30);
  document.getElementById('inv-due').value = due.toISOString().split('T')[0];

  // Set dashboard date
  document.getElementById('dashboard-date').textContent = new Date().toLocaleDateString('en-MY', {weekday:'long', year:'numeric', month:'long', day:'numeric'});

  // Set doc numbers
  document.getElementById('quo-number').value = getNextNum('quo');
  document.getElementById('quo-number-display').textContent = document.getElementById('quo-number').value;
  document.getElementById('inv-number').value = getNextNum('inv');
  document.getElementById('inv-number-display').textContent = document.getElementById('inv-number').value;

  // Seed default clients if none exist
  if (DB.getArr('clients').length === 0) {
    const defaults = [
      { id: 1, name: 'Techmile Resources Sdn Bhd', attn: '', email: '', phone: '', addr: '' },
      { id: 2, name: 'Shakur Resources Sdn Bhd', attn: 'Hafiz Razman', email: 'shakur.bizgroup@gmail.com', phone: '010-2147414', addr: '38, Jalan Perdana 5/4, Pandan Perdana, 55300 Kuala Lumpur' },
      { id: 3, name: 'Simplycare Bio Co., Ltd', attn: 'Jaero Yun', email: 'jryun@simplycare.co.kr', phone: '+82 10 5920 9792', addr: '2F, 46, Nonhyeon-ro 105-gil, Gangnam-gu, Seoul, Korea 06125' },
      { id: 4, name: 'Destra Sinistra Enterprise', attn: '', email: '', phone: '', addr: '' },
    ];
    DB.set('clients', defaults);
  }

  // Add initial line items
  addItem('quo');
  addItem('inv');

  refreshClientSelects();
  renderDashboard();
  renderClients();
  renderTracker('all');
  renderPL();
});

// ===== PAGE NAV =====
function showPage(name, navEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.remove('hidden');
  if (navEl) navEl.classList.add('active');

  if (name === 'tracker') renderTracker('all');
  if (name === 'dashboard') renderDashboard();
  if (name === 'clients') renderClients();
  if (name === 'reports') renderPL();
  if (name === 'new-quotation') {
    document.getElementById('quo-number').value = getNextNum('quo');
    document.getElementById('quo-number-display').textContent = document.getElementById('quo-number').value;
  }
  if (name === 'new-invoice') {
    document.getElementById('inv-number').value = getNextNum('inv');
    document.getElementById('inv-number-display').textContent = document.getElementById('inv-number').value;
  }
}

// ===== LINE ITEMS =====
function addItem(type, desc='', price='', qty='1') {
  const container = document.getElementById(type + '-items');
  const idx = container.children.length + 1;
  const row = document.createElement('div');
  row.className = 'line-item-row';
  row.innerHTML = `
    <span class="line-num">${idx}</span>
    <input type="text" placeholder="Description of goods/service" value="${desc}" oninput="calcTotals('${type}')">
    <input type="number" placeholder="0.00" value="${price}" min="0" step="0.01" style="text-align:right" oninput="calcTotals('${type}')">
    <input type="number" placeholder="1" value="${qty}" min="1" step="1" style="text-align:right" oninput="calcTotals('${type}')">
    <input type="text" readonly style="text-align:right;background:var(--cream);color:var(--teal-dark);font-family:'DM Mono',monospace" placeholder="0.00">
    <button class="remove-btn" onclick="removeItem(this, '${type}')">√ó</button>
  `;
  container.appendChild(row);
  calcTotals(type);
}

function removeItem(btn, type) {
  const container = document.getElementById(type + '-items');
  if (container.children.length > 1) {
    btn.closest('.line-item-row').remove();
    // Renumber
    [...container.children].forEach((row, i) => {
      row.querySelector('.line-num').textContent = i + 1;
    });
    calcTotals(type);
  }
}

function calcTotals(type) {
  const container = document.getElementById(type + '-items');
  let subtotal = 0;
  [...container.children].forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    const price = parseFloat(inputs[0].value) || 0;
    const qty = parseFloat(inputs[1].value) || 0;
    const amt = price * qty;
    row.querySelectorAll('input')[3].value = amt.toFixed(2);
    subtotal += amt;
  });

  const discount = parseFloat(document.getElementById(type + '-discount').value) || 0;
  const taxRate = parseFloat(document.getElementById(type + '-tax').value) || 0;
  const taxAmt = (subtotal - discount) * (taxRate / 100);
  const total = subtotal - discount + taxAmt;

  document.getElementById(type + '-subtotal').textContent = 'RM ' + subtotal.toFixed(2);
  document.getElementById(type + '-tax-amt').textContent = 'RM ' + taxAmt.toFixed(2);
  document.getElementById(type + '-total').textContent = 'RM ' + total.toFixed(2);
}

// ===== CLIENT FILL =====
function fillClientQuo(id) {
  if (!id) return;
  const clients = DB.getArr('clients');
  const c = clients.find(x => x.id == id);
  if (!c) return;
  document.getElementById('quo-client-name').value = c.name || '';
  document.getElementById('quo-client-attn').value = c.attn || '';
  document.getElementById('quo-client-addr').value = c.addr || '';
  document.getElementById('quo-client-email').value = c.email || '';
  document.getElementById('quo-client-phone').value = c.phone || '';
}

function fillClientInv(id) {
  if (!id) return;
  const clients = DB.getArr('clients');
  const c = clients.find(x => x.id == id);
  if (!c) return;
  document.getElementById('inv-client-name').value = c.name || '';
  document.getElementById('inv-client-attn').value = c.attn || '';
  document.getElementById('inv-client-addr').value = c.addr || '';
  document.getElementById('inv-client-email').value = c.email || '';
  document.getElementById('inv-client-phone').value = c.phone || '';
}

function refreshClientSelects() {
  const clients = DB.getArr('clients');
  ['quo-client-select', 'inv-client-select'].forEach(selId => {
    const sel = document.getElementById(selId);
    sel.innerHTML = '<option value="">‚Äî Select existing client ‚Äî</option>';
    clients.forEach(c => {
      sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
  });
}

// ===== COLLECT FORM DATA =====
function collectFormData(type) {
  const container = document.getElementById(type + '-items');
  const items = [...container.children].map(row => {
    const inputs = row.querySelectorAll('input');
    return {
      desc: inputs[1].value,
      price: parseFloat(inputs[2].value) || 0,
      qty: parseFloat(inputs[3].value) || 1,
      amount: parseFloat(inputs[4].value) || 0
    };
  }).filter(i => i.desc.trim());

  const discount = parseFloat(document.getElementById(type + '-discount').value) || 0;
  const taxRate = parseFloat(document.getElementById(type + '-tax').value) || 0;
  const subtotal = items.reduce((s, i) => s + i.amount, 0);
  const taxAmt = (subtotal - discount) * (taxRate / 100);
  const total = subtotal - discount + taxAmt;

  if (type === 'quo') {
    return {
      type: 'QUO',
      docNumber: document.getElementById('quo-number').value,
      date: document.getElementById('quo-date').value,
      validity: document.getElementById('quo-validity').value,
      clientName: document.getElementById('quo-client-name').value,
      clientAttn: document.getElementById('quo-client-attn').value,
      clientAddr: document.getElementById('quo-client-addr').value,
      clientEmail: document.getElementById('quo-client-email').value,
      clientPhone: document.getElementById('quo-client-phone').value,
      items, discount, taxRate, taxAmt, subtotal, total,
      notes: document.getElementById('quo-notes').value,
      terms: document.getElementById('quo-terms').value,
      status: 'sent', createdAt: new Date().toISOString()
    };
  } else {
    return {
      type: 'INV',
      docNumber: document.getElementById('inv-number').value,
      date: document.getElementById('inv-date').value,
      dueDate: document.getElementById('inv-due').value,
      refQuo: document.getElementById('inv-ref-quo').value,
      clientName: document.getElementById('inv-client-name').value,
      clientAttn: document.getElementById('inv-client-attn').value,
      clientAddr: document.getElementById('inv-client-addr').value,
      clientEmail: document.getElementById('inv-client-email').value,
      clientPhone: document.getElementById('inv-client-phone').value,
      items, discount, taxRate, taxAmt, subtotal, total,
      notes: document.getElementById('inv-notes').value,
      terms: document.getElementById('inv-terms').value,
      status: 'pending', createdAt: new Date().toISOString()
    };
  }
}

// ===== SAVE DOC =====
function saveDoc(type) {
  const data = collectFormData(type);
  if (!data.clientName) { showToast('Please enter a client name', 'error'); return; }
  if (!data.items.length) { showToast('Please add at least one line item', 'error'); return; }

  const docs = DB.getArr('documents');
  const existing = docs.findIndex(d => d.docNumber === data.docNumber);
  if (existing >= 0) docs[existing] = data;
  else docs.push(data);
  DB.set('documents', docs);

  // Auto-save client if new
  if (data.clientName) {
    const clients = DB.getArr('clients');
    if (!clients.find(c => c.name.toLowerCase() === data.clientName.toLowerCase())) {
      const newId = Date.now();
      clients.push({ id: newId, name: data.clientName, attn: data.clientAttn, email: data.clientEmail, phone: data.clientPhone, addr: data.clientAddr });
      DB.set('clients', clients);
      refreshClientSelects();
    }
  }

  showToast(`${data.docNumber} saved successfully!`, 'success');
  renderDashboard();
}

// ===== PREVIEW =====
function saveAndPreview(type) {
  saveDoc(type);
  const docs = DB.getArr('documents');
  const numEl = document.getElementById(type + '-number');
  const doc = docs.find(d => d.docNumber === numEl.value);
  if (!doc) return;
  currentPreviewType = type;
  showPreview(doc);
}

function showPreview(doc) {
  const container = document.getElementById('print-doc-container');
  container.innerHTML = buildPrintHTML(doc);
  document.getElementById('preview-overlay').classList.remove('hidden');
}

function closePreview() {
  document.getElementById('preview-overlay').classList.add('hidden');
}

function buildPrintHTML(doc) {
  const isInv = doc.type === 'INV';
  const fmtDate = d => d ? new Date(d + 'T00:00:00').toLocaleDateString('en-MY', {day:'2-digit', month:'short', year:'numeric'}) : '';
  const fmtMoney = n => 'RM ' + (parseFloat(n)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

  const itemRows = doc.items.map((item, i) => `
    <tr>
      <td style="color:#8AABA3;font-family:'DM Mono',monospace;font-size:11px">${i+1}</td>
      <td>${item.desc}</td>
      <td style="text-align:right">${fmtMoney(item.price)}</td>
      <td style="text-align:right">${item.qty}</td>
      <td style="text-align:right;font-weight:500">${fmtMoney(item.amount)}</td>
    </tr>
  `).join('');

  return `
    <div class="print-doc">
      <div class="print-header">
        <div>
          <div class="print-company-name">malko<span style="color:#14A886">‚Ä∫</span></div>
          <div class="print-company-tagline">Solutions Engineered, Value Delivered</div>
          <div class="print-company-info">
            MALKO SOLUTIONS | JR0170620-X<br>
            59, Tingkat 2, Jalan Tuanku Antah, 70100 Seremban, NS<br>
            +6017-2330580 | malkosolutions@gmail.com
          </div>
        </div>
        <div class="print-doc-type">
          <div class="print-doc-type-label">${isInv ? 'Invoice' : 'Quotation'}</div>
          <div class="print-doc-meta">
            <strong>${isInv ? 'Invoice' : 'Quotation'} No:</strong> ${doc.docNumber}<br>
            <strong>Date:</strong> ${fmtDate(doc.date)}<br>
            ${isInv ? `<strong>Due Date:</strong> ${fmtDate(doc.dueDate)}<br>` : `<strong>Valid For:</strong> ${doc.validity || 14} Days<br>`}
            ${isInv && doc.refQuo ? `<strong>Ref QUO:</strong> ${doc.refQuo}` : ''}
          </div>
        </div>
      </div>
      <hr class="print-divider">
      <div class="print-bill-to">
        <div class="print-bill-label">${isInv ? 'Billed To' : 'Quoted To'}</div>
        <div class="print-bill-name">${doc.clientName}</div>
        <div class="print-bill-info">
          ${doc.clientAttn ? 'Att: ' + doc.clientAttn + '<br>' : ''}
          ${doc.clientAddr ? doc.clientAddr.replace(/\n/g,'<br>') + '<br>' : ''}
          ${doc.clientEmail ? doc.clientEmail + '  ' : ''}${doc.clientPhone || ''}
        </div>
      </div>
      <table class="print-items">
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th>Description</th>
            <th style="text-align:right;width:120px">Unit Price</th>
            <th style="text-align:right;width:60px">Qty</th>
            <th style="text-align:right;width:120px">Amount</th>
          </tr>
        </thead>
        <tbody>${itemRows}</tbody>
      </table>
      <div class="print-totals">
        <div class="print-totals-box">
          <div class="print-totals-row"><span>Subtotal</span><span class="print-amount">${fmtMoney(doc.subtotal)}</span></div>
          ${doc.discount ? `<div class="print-totals-row"><span>Discount</span><span class="print-amount">- ${fmtMoney(doc.discount)}</span></div>` : ''}
          ${doc.taxRate ? `<div class="print-totals-row"><span>Tax (${doc.taxRate}%)</span><span class="print-amount">${fmtMoney(doc.taxAmt)}</span></div>` : ''}
          <div class="print-totals-row grand"><span>TOTAL</span><span class="print-amount">${fmtMoney(doc.total)}</span></div>
        </div>
      </div>
      <div class="print-footer">
        <div class="print-terms">
          <strong>Terms &amp; Conditions</strong><br>
          ${(doc.notes ? doc.notes + '<br><br>' : '')}
          ${(doc.terms || '').replace(/\n/g,'<br>')}
        </div>
        <div class="print-bank">
          <div class="print-bank-label">Payment To</div>
          <div class="print-bank-info">
            MALKO SOLUTIONS<br>
            CIMB Bank Berhad<br>
            8606011612
          </div>
        </div>
      </div>
      <div class="print-sig">
        <div class="print-sig-line"></div>
        <div class="print-sig-name">Muizz Zainuddin<br><span style="color:#8AABA3;font-size:10px">Alliance Director | Founder</span></div>
      </div>
    </div>
  `;
}

// ===== EXPORT XLSX =====
function exportDocXLSX(type) {
  const docs = DB.getArr('documents');
  const numEl = document.getElementById(type === 'quo' ? 'quo-number' : 'inv-number');
  const doc = docs.find(d => d.docNumber === numEl.value) || collectFormData(type);

  const fmtMoney = n => parseFloat(n || 0).toFixed(2);
  const fmtDate = d => d ? new Date(d + 'T00:00:00').toLocaleDateString('en-MY') : '';

  const wb = XLSX.utils.book_new();

  // Document sheet
  const docData = [
    ['MALKO SOLUTIONS', '', 'JR0170620-X'],
    ['59, Tingkat 2, Jalan Tuanku Antah, 70100 Seremban, NS', '', ''],
    ['Tel: +6017-2330580 | Email: malkosolutions@gmail.com', '', ''],
    [''],
    [doc.type === 'INV' ? 'INVOICE' : 'QUOTATION', '', doc.docNumber],
    ['Date:', fmtDate(doc.date), ''],
    [doc.type === 'INV' ? 'Due Date:' : 'Validity:', doc.type === 'INV' ? fmtDate(doc.dueDate) : (doc.validity || 14) + ' days', ''],
    [''],
    ['BILLED TO:'],
    [doc.clientName],
    [doc.clientAttn || ''],
    [(doc.clientAddr || '').replace(/\n/g, ', ')],
    [doc.clientEmail || '', '', doc.clientPhone || ''],
    [''],
    ['#', 'Description', 'Unit Price (RM)', 'Qty', 'Amount (RM)'],
    ...doc.items.map((item, i) => [i+1, item.desc, fmtMoney(item.price), item.qty, fmtMoney(item.amount)]),
    [''],
    ['', '', '', 'Subtotal:', fmtMoney(doc.subtotal)],
    ['', '', '', 'Discount:', fmtMoney(doc.discount || 0)],
    ['', '', '', `Tax (${doc.taxRate || 0}%):`, fmtMoney(doc.taxAmt || 0)],
    ['', '', '', 'TOTAL:', fmtMoney(doc.total)],
    [''],
    ['Terms & Conditions:'],
    [(doc.terms || '').replace(/\n/g, ' | ')],
    [''],
    ['Bank: CIMB Bank Berhad | MALKO SOLUTIONS | Acc: 8606011612'],
  ];

  const ws = XLSX.utils.aoa_to_sheet(docData);
  ws['!cols'] = [{wch:4},{wch:45},{wch:16},{wch:8},{wch:16}];
  XLSX.utils.book_append_sheet(wb, ws, doc.docNumber);
  XLSX.writeFile(wb, `${doc.docNumber}_MALKO.xlsx`);
  showToast(`${doc.docNumber} exported to Excel!`, 'success');
}

function exportTrackerXLSX() {
  const docs = DB.getArr('documents');
  const wb = XLSX.utils.book_new();

  const rows = [
    ['No.', 'Document No.', 'Type', 'Client', 'Description', 'Total (RM)', 'Date', 'Status'],
    ...docs.map((d, i) => [
      i+1, d.docNumber, d.type, d.clientName,
      d.items.map(x=>x.desc).join('; '),
      parseFloat(d.total).toFixed(2),
      d.date, d.status
    ])
  ];

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:5},{wch:14},{wch:8},{wch:35},{wch:50},{wch:14},{wch:12},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws, 'Job Tracker');
  XLSX.writeFile(wb, 'MALKO_Job_Tracker.xlsx');
  showToast('Tracker exported!', 'success');
}

function exportPLXLSX() {
  const docs = DB.getArr('documents').filter(d => d.type === 'INV');
  const wb = XLSX.utils.book_new();

  const rows = [
    ['MALKO SOLUTIONS ‚Äì Income Summary (for LHDN / IRB)', '', '', ''],
    ['JR0170620-X | Muizz Zainuddin', '', '', ''],
    [''],
    ['Invoice No.', 'Date', 'Client', 'Description', 'Amount (RM)', 'Status'],
    ...docs.map(d => [
      d.docNumber, d.date, d.clientName,
      d.items.map(x=>x.desc).join('; '),
      parseFloat(d.total).toFixed(2),
      d.status
    ]),
    [''],
    ['', '', '', 'TOTAL REVENUE:', docs.reduce((s,d) => s + (d.status==='paid' ? parseFloat(d.total) : 0), 0).toFixed(2)],
    ['', '', '', 'TOTAL OUTSTANDING:', docs.reduce((s,d) => s + (d.status!=='paid' ? parseFloat(d.total) : 0), 0).toFixed(2)],
  ];

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:14},{wch:12},{wch:35},{wch:50},{wch:14},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws, 'P&L Summary');
  XLSX.writeFile(wb, 'MALKO_Income_Summary_LHDN.xlsx');
  showToast('P&L exported for IRB!', 'success');
}

// ===== RESET FORM =====
function resetForm(type) {
  if (!confirm('Clear all form data?')) return;
  const today = new Date().toISOString().split('T')[0];
  if (type === 'quo') {
    ['quo-client-name','quo-client-attn','quo-client-addr','quo-client-email','quo-client-phone','quo-notes'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('quo-date').value = today;
    document.getElementById('quo-discount').value = '0';
    document.getElementById('quo-tax').value = '0';
    document.getElementById('quo-items').innerHTML = '';
    addItem('quo');
    const newNum = getNextNum('quo');
    document.getElementById('quo-number').value = newNum;
    document.getElementById('quo-number-display').textContent = newNum;
  } else {
    ['inv-client-name','inv-client-attn','inv-client-addr','inv-client-email','inv-client-phone','inv-notes','inv-ref-quo'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('inv-date').value = today;
    document.getElementById('inv-discount').value = '0';
    document.getElementById('inv-tax').value = '0';
    document.getElementById('inv-items').innerHTML = '';
    addItem('inv');
    const newNum = getNextNum('inv');
    document.getElementById('inv-number').value = newNum;
    document.getElementById('inv-number-display').textContent = newNum;
  }
}

// ===== DASHBOARD =====
function renderDashboard() {
  const docs = DB.getArr('documents');
  const invoices = docs.filter(d => d.type === 'INV');
  const quotes = docs.filter(d => d.type === 'QUO');

  const totalInvoiced = invoices.reduce((s,d) => s + parseFloat(d.total||0), 0);
  const outstanding = invoices.filter(d => d.status !== 'paid').reduce((s,d) => s + parseFloat(d.total||0), 0);

  document.getElementById('stat-invoiced').textContent = 'RM ' + totalInvoiced.toLocaleString('en-MY', {minimumFractionDigits:0, maximumFractionDigits:0});
  document.getElementById('stat-invoiced-count').textContent = invoices.length + ' invoice' + (invoices.length !== 1 ? 's' : '');
  document.getElementById('stat-outstanding').textContent = 'RM ' + outstanding.toLocaleString('en-MY', {minimumFractionDigits:0, maximumFractionDigits:0});
  document.getElementById('stat-outstanding-count').textContent = invoices.filter(d=>d.status!=='paid').length + ' pending';
  document.getElementById('stat-quotes').textContent = quotes.length;
  document.getElementById('stat-clients').textContent = DB.getArr('clients').length;

  // Recent invoices
  const invBody = document.getElementById('recent-invoices-body');
  const recentInv = invoices.slice(-5).reverse();
  invBody.innerHTML = recentInv.length ? recentInv.map(d => `
    <tr>
      <td><span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--teal-dark)">${d.docNumber}</span></td>
      <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.clientName}</td>
      <td style="font-family:'DM Mono',monospace">RM ${parseFloat(d.total).toFixed(2)}</td>
      <td><span class="badge badge-${d.status==='paid'?'paid':'pending'}">${d.status}</span></td>
    </tr>
  `).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--ink-muted);padding:20px">No invoices yet</td></tr>';

  const quoBody = document.getElementById('recent-quotes-body');
  const recentQuo = quotes.slice(-5).reverse();
  quoBody.innerHTML = recentQuo.length ? recentQuo.map(d => `
    <tr>
      <td><span style="font-family:'DM Mono',monospace;font-size:12px;color:#4F46E5">${d.docNumber}</span></td>
      <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.clientName}</td>
      <td style="font-family:'DM Mono',monospace">RM ${parseFloat(d.total).toFixed(2)}</td>
      <td style="font-size:12px;color:var(--ink-muted)">${d.date || ''}</td>
    </tr>
  `).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--ink-muted);padding:20px">No quotations yet</td></tr>';
}

// ===== TRACKER =====
let trackerFilter = 'all';

function renderTracker(filter) {
  trackerFilter = filter;
  const docs = DB.getArr('documents');
  let filtered = docs;
  if (filter === 'QUO') filtered = docs.filter(d => d.type === 'QUO');
  else if (filter === 'INV') filtered = docs.filter(d => d.type === 'INV');
  else if (filter === 'paid') filtered = docs.filter(d => d.status === 'paid');
  else if (filter === 'pending') filtered = docs.filter(d => d.status === 'pending');

  const tbody = document.getElementById('tracker-body');
  const emptyEl = document.getElementById('tracker-empty');

  if (!filtered.length) {
    tbody.innerHTML = '';
    emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');

  tbody.innerHTML = [...filtered].reverse().map(d => `
    <tr>
      <td>
        <span style="font-family:'DM Mono',monospace;font-size:12px;color:${d.type==='INV'?'var(--gold)':'#4F46E5'};font-weight:600">${d.docNumber}</span>
      </td>
      <td><span class="badge badge-${d.type==='INV'?'inv':'quo'}">${d.type}</span></td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.clientName}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;color:var(--ink-soft)">${d.items.map(x=>x.desc).join(', ')}</td>
      <td style="font-family:'DM Mono',monospace;font-size:13px">RM ${parseFloat(d.total).toFixed(2)}</td>
      <td style="font-size:12px;color:var(--ink-muted)">${d.date || ''}</td>
      <td>
        <select onchange="updateStatus('${d.docNumber}', this.value)" style="font-size:12px;padding:4px 8px;border-radius:6px;border:1.5px solid var(--border)">
          <option value="draft" ${d.status==='draft'?'selected':''}>Draft</option>
          <option value="sent" ${d.status==='sent'?'selected':''}>Sent</option>
          <option value="pending" ${d.status==='pending'?'selected':''}>Pending</option>
          <option value="paid" ${d.status==='paid'?'selected':''}>Paid ‚úì</option>
          <option value="cancelled" ${d.status==='cancelled'?'selected':''}>Cancelled</option>
        </select>
      </td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="previewFromTracker('${d.docNumber}')">View</button>
          <button class="btn btn-ghost btn-sm" onclick="deleteDoc('${d.docNumber}')" style="color:var(--warn)">Del</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function filterTracker(filter, el) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderTracker(filter);
}

function updateStatus(docNum, status) {
  const docs = DB.getArr('documents');
  const d = docs.find(x => x.docNumber === docNum);
  if (d) { d.status = status; DB.set('documents', docs); }
  renderDashboard();
  showToast(`${docNum} marked as ${status}`, 'success');
}

function previewFromTracker(docNum) {
  const docs = DB.getArr('documents');
  const d = docs.find(x => x.docNumber === docNum);
  if (d) { currentPreviewType = d.type.toLowerCase() === 'inv' ? 'inv' : 'quo'; showPreview(d); }
}

function deleteDoc(docNum) {
  if (!confirm(`Delete ${docNum}? This cannot be undone.`)) return;
  const docs = DB.getArr('documents').filter(d => d.docNumber !== docNum);
  DB.set('documents', docs);
  renderTracker(trackerFilter);
  renderDashboard();
  showToast(`${docNum} deleted`, 'error');
}

// ===== CLIENTS =====
function renderClients() {
  const clients = DB.getArr('clients');
  const grid = document.getElementById('client-grid');
  const empty = document.getElementById('clients-empty');
  if (!clients.length) {
    grid.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');
  grid.innerHTML = clients.map(c => `
    <div class="client-card" onclick="editClient(${c.id})">
      <div class="client-name">${c.name}</div>
      <div class="client-ref">${c.email || 'No email'}</div>
      <div class="client-info">
        ${c.attn ? 'üë§ ' + c.attn + '<br>' : ''}
        ${c.phone ? 'üìû ' + c.phone + '<br>' : ''}
        ${c.addr ? 'üìç ' + c.addr.split('\n')[0] : ''}
      </div>
      <div style="margin-top:10px;display:flex;gap:6px">
        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();editClient(${c.id})">Edit</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteClient(${c.id})" style="color:var(--warn)">Remove</button>
      </div>
    </div>
  `).join('');
}

function openClientModal(client) {
  document.getElementById('client-id').value = client ? client.id : '';
  document.getElementById('cm-name').value = client ? client.name : '';
  document.getElementById('cm-attn').value = client ? client.attn : '';
  document.getElementById('cm-email').value = client ? client.email : '';
  document.getElementById('cm-phone').value = client ? client.phone : '';
  document.getElementById('cm-addr').value = client ? client.addr : '';
  document.getElementById('client-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('cm-name').focus(), 100);
}

function editClient(id) {
  const c = DB.getArr('clients').find(x => x.id === id);
  if (c) openClientModal(c);
}

function closeClientModal() {
  document.getElementById('client-modal').classList.add('hidden');
}

function saveClient() {
  const id = document.getElementById('client-id').value;
  const name = document.getElementById('cm-name').value.trim();
  if (!name) { showToast('Client name is required', 'error'); return; }

  const clients = DB.getArr('clients');
  const client = {
    id: id ? parseInt(id) : Date.now(),
    name,
    attn: document.getElementById('cm-attn').value,
    email: document.getElementById('cm-email').value,
    phone: document.getElementById('cm-phone').value,
    addr: document.getElementById('cm-addr').value,
  };

  if (id) {
    const idx = clients.findIndex(c => c.id == id);
    if (idx >= 0) clients[idx] = client;
  } else {
    clients.push(client);
  }

  DB.set('clients', clients);
  refreshClientSelects();
  renderClients();
  closeClientModal();
  showToast(`${name} saved to address book`, 'success');
  renderDashboard();
}

function deleteClient(id) {
  if (!confirm('Remove this client?')) return;
  const clients = DB.getArr('clients').filter(c => c.id !== id);
  DB.set('clients', clients);
  refreshClientSelects();
  renderClients();
  renderDashboard();
}

// ===== P&L REPORT =====
function renderPL() {
  const docs = DB.getArr('documents');
  const invoices = docs.filter(d => d.type === 'INV');
  const quotes = docs.filter(d => d.type === 'QUO');

  const paidInvoices = invoices.filter(d => d.status === 'paid');
  const totalRevenue = paidInvoices.reduce((s,d) => s + parseFloat(d.total||0), 0);
  const outstanding = invoices.filter(d=>d.status!=='paid').reduce((s,d) => s + parseFloat(d.total||0), 0);
  const convRate = quotes.length ? Math.round((invoices.length / quotes.length) * 100) : 0;

  document.getElementById('pl-revenue').textContent = 'RM ' + totalRevenue.toLocaleString('en-MY', {minimumFractionDigits:0});
  document.getElementById('pl-outstanding').textContent = 'RM ' + outstanding.toLocaleString('en-MY', {minimumFractionDigits:0});
  document.getElementById('pl-conv').textContent = convRate + '%';

  // Monthly breakdown
  const monthly = {};
  invoices.forEach(d => {
    if (!d.date) return;
    const key = d.date.substring(0,7);
    if (!monthly[key]) monthly[key] = { count: 0, total: 0, paid: 0, pending: 0 };
    monthly[key].count++;
    monthly[key].total += parseFloat(d.total||0);
    if (d.status === 'paid') monthly[key].paid += parseFloat(d.total||0);
    else monthly[key].pending += parseFloat(d.total||0);
  });

  const plBody = document.getElementById('pl-body');
  const months = Object.keys(monthly).sort().reverse();
  plBody.innerHTML = months.length ? months.map(m => {
    const mo = monthly[m];
    return `<tr>
      <td>${new Date(m+'-01').toLocaleDateString('en-MY',{month:'long',year:'numeric'})}</td>
      <td>${mo.count}</td>
      <td style="font-family:'DM Mono',monospace">RM ${mo.total.toFixed(2)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--teal)">RM ${mo.paid.toFixed(2)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--warn)">RM ${mo.pending.toFixed(2)}</td>
    </tr>`;
  }).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--ink-muted);padding:20px">No invoice data yet</td></tr>';

  const detailBody = document.getElementById('pl-detail-body');
  detailBody.innerHTML = [...invoices].reverse().map(d => `
    <tr>
      <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--gold)">${d.docNumber}</td>
      <td style="font-size:12px">${d.date||''}</td>
      <td>${d.clientName}</td>
      <td style="font-size:12px;color:var(--ink-soft)">${d.items.map(x=>x.desc).join(', ')}</td>
      <td style="font-family:'DM Mono',monospace">RM ${parseFloat(d.total).toFixed(2)}</td>
      <td><span class="badge badge-${d.status==='paid'?'paid':'pending'}">${d.status}</span></td>
    </tr>
  `).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--ink-muted);padding:20px">No invoices yet</td></tr>';
}

// ===== TOAST =====
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = (type === 'success' ? '‚úì ' : '‚ö† ') + msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(() => { t.className = 'toast'; }, 3000);
}

// Keyboard shortcut: Escape closes preview / modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePreview();
    closeClientModal();
  }
});
</script>
</body>
</html>
